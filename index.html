<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Word Quest ¬∑ Telegram Mini App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, system-ui, -apple-system, sans-serif;
        }

        body {
            background: linear-gradient(145deg, #1a2f3f 0%, #1e3a4a 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 12px;
            margin: 0;
        }

        .game-container {
            max-width: 550px;
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 42px;
            padding: 24px 20px 30px;
            box-shadow: 0 25px 40px -10px rgba(0, 0, 0, 0.5);
            transition: all 0.2s;
        }

        /* header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            color: white;
            padding: 0 5px;
        }

        .title {
            font-weight: 700;
            font-size: 26px;
            letter-spacing: 1px;
            background: linear-gradient(135deg, #ffe99c, #ffd78c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        .progress-badge {
            background: rgba(255, 215, 140, 0.25);
            border: 1px solid rgba(255, 235, 150, 0.6);
            border-radius: 60px;
            padding: 8px 16px;
            font-weight: 600;
            font-size: 18px;
            color: #ffefc0;
            backdrop-filter: blur(4px);
        }

        /* word list area */
        .word-section {
            background: rgba(10, 25, 35, 0.7);
            border-radius: 38px;
            padding: 18px 15px;
            margin-bottom: 22px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.4);
        }

        .section-label {
            color: #b6d8e6;
            font-size: 15px;
            font-weight: 500;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            padding-left: 8px;
        }

        .word-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .word-chip {
            background: #2c4556;
            border-radius: 40px;
            padding: 12px 22px;
            font-weight: 600;
            font-size: 18px;
            color: #c9e9ff;
            box-shadow: 0 6px 0 #0f1f29, 0 8px 10px rgba(0,0,0,0.3);
            transition: all 0.1s ease;
            border: 1px solid #598baa;
            user-select: none;
            cursor: pointer;
            min-width: 90px;
            text-align: center;
        }

        .word-chip.completed {
            background: #3f6a4a;
            color: #d9ffd9;
            border-color: #a5d6a5;
            box-shadow: 0 4px 0 #1b3b24, 0 6px 8px rgba(0,0,0,0.3);
            text-decoration: line-through 2px rgba(255,255,255,0.4);
            opacity: 0.8;
            cursor: default;
            pointer-events: none;
        }

        .word-chip.active-word {
            background: #f5c542;
            color: #1e2f3a;
            border-color: #ffea9e;
            box-shadow: 0 0 0 3px #fce49c, 0 6px 0 #a07d2b;
            transform: scale(1.02);
            font-weight: 800;
        }

        /* letter bank */
        .letter-section {
            background: rgba(10, 25, 35, 0.7);
            border-radius: 38px;
            padding: 18px 12px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .letter-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
        }

        .letter-tile {
            width: 62px;
            height: 62px;
            background: linear-gradient(145deg, #ffcf8a, #febf6e);
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 34px;
            color: #1f3b4a;
            box-shadow: 0 9px 0 #b2752e, 0 10px 18px rgba(0, 0, 0, 0.4);
            transition: all 0.08s linear;
            cursor: pointer;
            border: 2px solid #ffdcaa;
            text-transform: uppercase;
            user-select: none;
        }

        .letter-tile:active {
            transform: translateY(6px);
            box-shadow: 0 3px 0 #b2752e, 0 8px 12px rgba(0,0,0,0.4);
        }

        .letter-tile.used {
            background: #3a4d5e;
            box-shadow: 0 4px 0 #1d2c36, 0 6px 8px rgba(0,0,0,0.3);
            border-color: #5b7485;
            color: #a1b9cc;
            cursor: not-allowed;
            transform: translateY(5px);
            pointer-events: none;
            opacity: 0.5;
        }

        .letter-tile:not(.used) {
            cursor: pointer;
        }

        /* active word hint */
        .active-hint {
            background: #244454;
            border-radius: 30px;
            padding: 15px 18px;
            margin: 18px 0 10px;
            text-align: center;
            border-left: 8px solid #f5c542;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .target-word {
            font-size: 26px;
            font-weight: 700;
            letter-spacing: 6px;
            color: #ffea9a;
        }

        .next-letter {
            background: #f5c542;
            color: #1f2e3a;
            padding: 8px 25px;
            border-radius: 50px;
            font-weight: 700;
            font-size: 24px;
            min-width: 70px;
            text-align: center;
            box-shadow: 0 4px 0 #946f2c;
        }

        /* reset button */
        .reset-btn {
            background: #334e62;
            border: none;
            border-radius: 60px;
            padding: 18px 25px;
            font-weight: 700;
            font-size: 20px;
            color: #ffefcf;
            box-shadow: 0 8px 0 #1c2f3b, 0 6px 15px black;
            cursor: pointer;
            width: 100%;
            transition: 0.08s;
            border: 1px solid #63879e;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .reset-btn:active {
            transform: translateY(5px);
            box-shadow: 0 3px 0 #1c2f3b, 0 6px 10px black;
        }

        /* popup card modal */
        .popup-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: all 0.3s;
        }

        .reward-card {
            max-width: 380px;
            width: 90%;
            background: linear-gradient(165deg, #fff8e7, #ffffff);
            border-radius: 58px;
            padding: 30px 20px 30px;
            box-shadow: 0 30px 50px #00000080, 0 0 0 6px #fad87c;
            text-align: center;
            animation: pop 0.3s cubic-bezier(0.2, 0.9, 0.3, 1.3);
            border: 3px solid #ffcd7e;
        }

        @keyframes pop {
            0% { transform: scale(0.7); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .card-emoji {
            font-size: 110px;
            line-height: 1.2;
            margin: 5px 0 10px;
            filter: drop-shadow(8px 12px 0 rgba(0,0,0,0.2));
        }

        .card-word {
            font-size: 58px;
            font-weight: 900;
            color: #1f4a5c;
            text-transform: uppercase;
            letter-spacing: 3px;
            text-shadow: 3px 5px 0 #ffcd7e;
            margin: 5px 0;
        }

        .card-sentence {
            font-size: 22px;
            background: #ebcba0;
            padding: 20px 18px;
            border-radius: 40px;
            color: #1f3a47;
            font-weight: 500;
            margin: 20px 0 18px;
            border: 2px dashed #a5723b;
            line-height: 1.4;
        }

        .card-btn {
            background: #f5b342;
            border: none;
            border-radius: 60px;
            padding: 18px 25px;
            font-weight: 700;
            font-size: 26px;
            color: #1f3826;
            box-shadow: 0 7px 0 #9e691f;
            cursor: pointer;
            width: 100%;
            border: 2px solid #ffe39b;
        }

        .hidden {
            display: none;
        }

        /* artifact area */
        .artifact-box {
            background: #1d3643;
            border-radius: 32px;
            margin: 15px 0 10px;
            padding: 14px 20px;
            color: #ffeec2;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 24px;
            font-weight: 700;
            border: 2px solid #c5a15b;
        }

        .artifact-icon {
            font-size: 44px;
            filter: drop-shadow(0 4px 2px black);
        }

        .telegram-footer {
            font-size: 14px;
            text-align: center;
            color: #aac3d0;
            margin-top: 20px;
        }
    </style>
</head>
<body>
<div class="game-container" id="gameContainer">
    <!-- header -->
    <div class="header">
        <span class="title">‚ú® WORD QUEST</span>
        <span class="progress-badge" id="progressDisplay">0/20</span>
    </div>

    <!-- word list -->
    <div class="word-section">
        <div class="section-label">üìã WORDS TO COLLECT ¬∑ tap any to start</div>
        <div class="word-grid" id="wordListContainer"></div>
    </div>

    <!-- active word hint -->
    <div class="active-hint" id="activeHintArea">
        <span class="target-word" id="activeWordDisplay">‚Äî</span>
        <span class="next-letter" id="nextLetterDisplay">?</span>
    </div>

    <!-- letter grid -->
    <div class="letter-section">
        <div class="section-label">üî§ LETTER BANK ¬∑ tap in order</div>
        <div class="letter-grid" id="letterGridContainer"></div>
    </div>

    <!-- artifact progress -->
    <div class="artifact-box" id="artifactBox">
        <span class="artifact-icon">üèÜ</span>
        <span id="artifactText">LOCKED</span>
        <span>‚ö°</span>
    </div>

    <!-- reset button -->
    <button class="reset-btn" id="resetButton">üîÑ RESET ADVENTURE</button>
    <div class="telegram-footer">Telegram Mini App ¬∑ spell to unlock</div>
</div>

<!-- popup card modal (hidden by default) -->
<div id="popupOverlay" class="popup-overlay hidden">
    <div class="reward-card" id="rewardCard">
        <div class="card-emoji" id="cardEmoji">üé¥</div>
        <div class="card-word" id="cardWord">WORD</div>
        <div class="card-sentence" id="cardSentence">Amazing sentence here.</div>
        <button class="card-btn" id="closePopupBtn">‚ú® COLLECT</button>
    </div>
</div>

<script>
    (function() {
        // ---------- TELEGRAM WEB APP INTEGRATION ----------
        let tg = window.Telegram?.WebApp;
        if (tg) {
            tg.expand();          // expand to full height
            tg.enableClosingConfirmation?.(); 
            tg.setHeaderColor?.(bgColor || '#1a2f3f');
        }

        // ---------- WORD DATABASE with images/emojis + sentences ----------
        const wordsDatabase = [
            { word: "alien", emoji: "üëΩ", sentence: "The friendly alien played guitar with astronauts." },
            { word: "among", emoji: "üïµÔ∏è", sentence: "A red mushroom stood among the green ferns." },
            { word: "chart", emoji: "üìä", sentence: "We made a chart of everyone's favorite pizza." },
            { word: "cloud", emoji: "‚òÅÔ∏è", sentence: "That cloud looks exactly like a dragon." },
            { word: "comprehend", emoji: "üß†", sentence: "It's hard to comprehend how big the universe is." },
            { word: "describe", emoji: "üó£Ô∏è", sentence: "Can you describe your perfect day?" },
            { word: "ever", emoji: "üåü", sentence: "This is the most beautiful sunset ever." },
            { word: "fail", emoji: "üò§", sentence: "It's okay to fail when you're learning something new." },
            { word: "friendly", emoji: "üêï", sentence: "The friendly dog wagged its tail at everyone." },
            { word: "grade", emoji: "üìù", sentence: "She got an A+ on her spelling grade." },
            { word: "instead", emoji: "üîÑ", sentence: "Let's play outside instead of watching TV." },
            { word: "library", emoji: "üìö", sentence: "The library has a story hour every Tuesday." },
            { word: "planet", emoji: "ü™ê", sentence: "Which planet has the most beautiful rings?" },
            { word: "report", emoji: "üì∞", sentence: "I need to write a report about frogs." },
            { word: "several", emoji: "üßÆ", sentence: "I've read several books by that author." },
            { word: "solve", emoji: "üß©", sentence: "Together we can solve any puzzle." },
            { word: "suddenly", emoji: "‚ö°", sentence: "Suddenly, the room filled with colorful light." },
            { word: "suppose", emoji: "ü§î", sentence: "I suppose we could share the last cookie." },
            { word: "universe", emoji: "üåå", sentence: "How many stars are in the universe?" },
            { word: "view", emoji: "üèûÔ∏è", sentence: "The view from the mountain was incredible." }
        ];

        // initial letter bank generation (scrambled from all words)
        function generateInitialLetters() {
            let allChars = [];
            wordsDatabase.forEach(entry => {
                allChars.push(...entry.word.split(''));
            });
            // scramble
            for (let i = allChars.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [allChars[i], allChars[j]] = [allChars[j], allChars[i]];
            }
            return allChars;
        }

        // Game state
        let currentLetters = [];                // array of available letters (strings)
        let completedWords = [];                 // indexes of completed words
        let activeWordIndex = null;               // which word is selected (index)
        let currentPosition = 0;                   // next letter index to find (0..len-1)
        let allWords = wordsDatabase.map(w => w.word);
        
        // Initialize or reset state
        function resetGame() {
            currentLetters = generateInitialLetters();
            completedWords = [];
            activeWordIndex = null;
            currentPosition = 0;
            renderAll();
            hidePopup();
        }

        // helper: get word object by index
        function getWordData(idx) {
            return wordsDatabase[idx];
        }

        // Check if all words completed -> unlock artifact
        function isGameComplete() {
            return completedWords.length === allWords.length;
        }

        // complete active word (called when word spelled correctly)
        function completeActiveWord() {
            if (activeWordIndex === null) return;
            if (completedWords.includes(activeWordIndex)) return; // already done

            // mark completed
            completedWords.push(activeWordIndex);
            // remove active selection
            activeWordIndex = null;
            currentPosition = 0;

            // show popup for that word
            const wordIdx = activeWordIndex; // but active set null already, so store before null?
            // Actually we need index before setting null
            // let's re-fetch: last active index before null
            const lastWordIdx = activeWordIndex; // but we set null after? let's do differently.
        }

        // We'll call this after a word is fully spelled
        function handleWordCompletion(completedIdx) {
            // add to completed list (if not already)
            if (!completedWords.includes(completedIdx)) {
                completedWords.push(completedIdx);
            }
            // get card data
            const wordData = getWordData(completedIdx);
            // show popup
            showPopup(wordData);
            // deactivate word
            activeWordIndex = null;
            currentPosition = 0;

            renderAll();  // re-render word list & letters
            if (isGameComplete()) {
                document.getElementById('artifactText').innerText = 'UNLOCKED! üéâ';
            }
        }

        // attempt to tap letter
        function handleLetterTap(letter, indexInGrid) {
            // valid only if an active word is selected and not completed
            if (activeWordIndex === null) {
                // maybe show hint: select a word first
                tg?.HapticFeedback?.notificationOccurred?.('warning');
                return;
            }
            if (completedWords.includes(activeWordIndex)) {
                // word already completed: deactivate or ignore
                activeWordIndex = null;
                currentPosition = 0;
                renderAll();
                return;
            }

            const targetWord = allWords[activeWordIndex];
            const neededLetter = targetWord[currentPosition];

            // must match case (lowercase)
            if (letter.toLowerCase() !== neededLetter.toLowerCase()) {
                // wrong letter
                tg?.HapticFeedback?.notificationOccurred?.('error');
                return;
            }

            // correct! remove letter from currentLetters
            const removed = currentLetters.splice(indexInGrid, 1)[0];
            // move position forward
            currentPosition++;

            tg?.HapticFeedback?.impactOccurred?.('light');

            // check if whole word completed
            if (currentPosition === targetWord.length) {
                // word finished!
                handleWordCompletion(activeWordIndex);
            } else {
                // word still in progress: just re-render
                renderAll();
            }
        }

        // show popup with word data
        function showPopup(wordData) {
            document.getElementById('cardEmoji').innerText = wordData.emoji || 'üî§';
            document.getElementById('cardWord').innerText = wordData.word.toUpperCase();
            document.getElementById('cardSentence').innerText = wordData.sentence;
            document.getElementById('popupOverlay').classList.remove('hidden');
            tg?.HapticFeedback?.notificationOccurred?.('success');
        }

        function hidePopup() {
            document.getElementById('popupOverlay').classList.add('hidden');
        }

        // render entire UI
        function renderAll() {
            // word list
            const wordContainer = document.getElementById('wordListContainer');
            wordContainer.innerHTML = '';
            allWords.forEach((w, idx) => {
                const chip = document.createElement('div');
                chip.className = 'word-chip';
                if (completedWords.includes(idx)) {
                    chip.classList.add('completed');
                } else if (activeWordIndex === idx) {
                    chip.classList.add('active-word');
                }
                chip.innerText = w;
                chip.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (completedWords.includes(idx)) return; // can't select completed
                    // set active word
                    if (activeWordIndex === idx) {
                        // if already active, maybe just keep
                    } else {
                        activeWordIndex = idx;
                        currentPosition = 0; // reset progress on new word
                    }
                    renderAll();
                    tg?.HapticFeedback?.selectionChanged?.();
                });
                wordContainer.appendChild(chip);
            });

            // active hint area
            if (activeWordIndex !== null && !completedWords.includes(activeWordIndex)) {
                const w = allWords[activeWordIndex];
                const progressWord = w.split('').map((l, i) => i < currentPosition ? l.toUpperCase() : '_').join(' ');
                document.getElementById('activeWordDisplay').innerText = progressWord || '‚Äî';
                const nextChar = (currentPosition < w.length) ? w[currentPosition].toUpperCase() : '‚úÖ';
                document.getElementById('nextLetterDisplay').innerText = nextChar;
            } else {
                document.getElementById('activeWordDisplay').innerText = '‚Äî';
                document.getElementById('nextLetterDisplay').innerText = '?';
            }

            // letter grid
            const gridContainer = document.getElementById('letterGridContainer');
            gridContainer.innerHTML = '';
            currentLetters.forEach((letter, idx) => {
                const tile = document.createElement('div');
                tile.className = 'letter-tile';
                tile.innerText = letter.toUpperCase();
                tile.addEventListener('click', (e) => {
                    e.preventDefault();
                    handleLetterTap(letter, idx);
                });
                gridContainer.appendChild(tile);
            });

            // progress
            document.getElementById('progressDisplay').innerText = `${completedWords.length}/${allWords.length}`;
            // artifact text
            const artifactEl = document.getElementById('artifactText');
            if (completedWords.length === allWords.length) {
                artifactEl.innerText = 'üåü ARTIFACT UNLOCKED! üåü';
            } else {
                artifactEl.innerText = `üîí LOCKED (${completedWords.length}/${allWords.length})`;
            }
        }

        // reset with confirmation
        function confirmReset() {
            if (tg) {
                tg.showConfirm('Restart from beginning? All progress will be lost.', (ok) => {
                    if (ok) {
                        resetGame();
                        tg.HapticFeedback?.impactOccurred?.('heavy');
                    }
                });
            } else {
                if (confirm('Restart from beginning?')) {
                    resetGame();
                }
            }
        }

        // event listeners
        document.getElementById('resetButton').addEventListener('click', confirmReset);
        document.getElementById('closePopupBtn').addEventListener('click', () => {
            hidePopup();
            renderAll(); // ensure fresh
        });
        document.getElementById('popupOverlay').addEventListener('click', (e) => {
            if (e.target.classList.contains('popup-overlay')) hidePopup();
        });

        // initial reset / start
        resetGame();

        // Telegram back button handling
        if (tg) {
            tg.onEvent('backButtonClicked', () => {
                tg.close();
            });
            tg.BackButton?.show();
            tg.ready();
        }
    })();
</script>
</body>
</html>
