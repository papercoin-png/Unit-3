<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spellforge ¬∑ Telegram Mini App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, system-ui, -apple-system, sans-serif;
        }

        body {
            background: linear-gradient(145deg, #1a2f3f 0%, #1e3a4a 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 12px;
            margin: 0;
        }

        .game-container {
            max-width: 550px;
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 42px;
            padding: 24px 20px 30px;
            box-shadow: 0 25px 40px -10px rgba(0, 0, 0, 0.5);
            transition: all 0.2s;
        }

        /* header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            color: white;
            padding: 0 5px;
        }

        .title {
            font-weight: 700;
            font-size: 26px;
            letter-spacing: 1px;
            background: linear-gradient(135deg, #ffe99c, #ffd78c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        .progress-badge {
            background: rgba(255, 215, 140, 0.25);
            border: 1px solid rgba(255, 235, 150, 0.6);
            border-radius: 60px;
            padding: 8px 16px;
            font-weight: 600;
            font-size: 18px;
            color: #ffefc0;
            backdrop-filter: blur(4px);
        }

        /* word list area */
        .word-section {
            background: rgba(10, 25, 35, 0.7);
            border-radius: 38px;
            padding: 18px 15px;
            margin-bottom: 22px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.4);
        }

        .section-label {
            color: #b6d8e6;
            font-size: 15px;
            font-weight: 500;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            padding-left: 8px;
        }

        .word-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .word-chip {
            background: #2c4556;
            border-radius: 40px;
            padding: 12px 22px;
            font-weight: 600;
            font-size: 18px;
            color: #c9e9ff;
            box-shadow: 0 6px 0 #0f1f29, 0 8px 10px rgba(0,0,0,0.3);
            transition: all 0.1s ease;
            border: 1px solid #598baa;
            user-select: none;
            cursor: pointer;
            min-width: 90px;
            text-align: center;
        }

        .word-chip.completed {
            background: #3f6a4a;
            color: #d9ffd9;
            border-color: #a5d6a5;
            box-shadow: 0 4px 0 #1b3b24, 0 6px 8px rgba(0,0,0,0.3);
            text-decoration: line-through 2px rgba(255,255,255,0.4);
            opacity: 0.8;
            cursor: default;
            pointer-events: none;
        }

        .word-chip.active-word {
            background: #f5c542;
            color: #1e2f3a;
            border-color: #ffea9e;
            box-shadow: 0 0 0 3px #fce49c, 0 6px 0 #a07d2b;
            transform: scale(1.02);
            font-weight: 800;
        }

        /* letter bank */
        .letter-section {
            background: rgba(10, 25, 35, 0.7);
            border-radius: 38px;
            padding: 18px 12px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .letter-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
        }

        .letter-tile {
            width: 62px;
            height: 62px;
            background: linear-gradient(145deg, #ffcf8a, #febf6e);
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 34px;
            color: #1f3b4a;
            box-shadow: 0 9px 0 #b2752e, 0 10px 18px rgba(0, 0, 0, 0.4);
            transition: all 0.08s linear;
            cursor: pointer;
            border: 2px solid #ffdcaa;
            text-transform: uppercase;
            user-select: none;
        }

        .letter-tile:active {
            transform: translateY(6px);
            box-shadow: 0 3px 0 #b2752e, 0 8px 12px rgba(0,0,0,0.4);
        }

        .letter-tile.used {
            background: #3a4d5e;
            box-shadow: 0 4px 0 #1d2c36, 0 6px 8px rgba(0,0,0,0.3);
            border-color: #5b7485;
            color: #a1b9cc;
            cursor: not-allowed;
            transform: translateY(5px);
            pointer-events: none;
            opacity: 0.5;
        }

        .letter-tile:not(.used) {
            cursor: pointer;
        }

        /* active word hint */
        .active-hint {
            background: #244454;
            border-radius: 30px;
            padding: 15px 18px;
            margin: 18px 0 10px;
            text-align: center;
            border-left: 8px solid #f5c542;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .target-word {
            font-size: 26px;
            font-weight: 700;
            letter-spacing: 6px;
            color: #ffea9a;
        }

        .next-letter {
            background: #f5c542;
            color: #1f2e3a;
            padding: 8px 25px;
            border-radius: 50px;
            font-weight: 700;
            font-size: 24px;
            min-width: 70px;
            text-align: center;
            box-shadow: 0 4px 0 #946f2c;
        }

        /* reset button */
        .reset-btn {
            background: #334e62;
            border: none;
            border-radius: 60px;
            padding: 18px 25px;
            font-weight: 700;
            font-size: 20px;
            color: #ffefcf;
            box-shadow: 0 8px 0 #1c2f3b, 0 6px 15px black;
            cursor: pointer;
            width: 100%;
            transition: 0.08s;
            border: 1px solid #63879e;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .reset-btn:active {
            transform: translateY(5px);
            box-shadow: 0 3px 0 #1c2f3b, 0 6px 10px black;
        }

        /* popup overlay base */
        .popup-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: all 0.3s;
            padding: 16px;
            box-sizing: border-box;
            overflow-y: auto;
        }

        /* word card */
        .word-card {
            max-width: 380px;
            width: 100%;
            background: linear-gradient(165deg, #fff8e7, #ffffff);
            border-radius: 58px;
            padding: 30px 20px;
            box-shadow: 0 30px 50px #00000080, 0 0 0 6px #fad87c;
            text-align: center;
            animation: pop 0.3s cubic-bezier(0.2, 0.9, 0.3, 1.3);
            border: 3px solid #ffcd7e;
            margin: auto;
        }

        @keyframes pop {
            0% { transform: scale(0.7); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .word-emoji {
            font-size: 110px;
            line-height: 1.2;
            margin: 5px 0;
        }

        .word-title {
            font-size: 58px;
            font-weight: 900;
            color: #1f4a5c;
            text-transform: uppercase;
            letter-spacing: 3px;
            text-shadow: 3px 5px 0 #ffcd7e;
            margin: 5px 0;
            word-break: break-word;
        }

        .word-sentence {
            font-size: 22px;
            background: #ebcba0;
            padding: 20px;
            border-radius: 40px;
            color: #1f3a47;
            font-weight: 500;
            margin: 20px 0;
            border: 2px dashed #a5723b;
            word-break: break-word;
        }

        .collect-btn {
            background: #f5b342;
            border: none;
            border-radius: 60px;
            padding: 18px;
            font-weight: 700;
            font-size: 26px;
            color: #1f3826;
            box-shadow: 0 7px 0 #9e691f;
            cursor: pointer;
            width: 100%;
            border: 2px solid #ffe39b;
        }

        .collect-btn:active {
            transform: translateY(5px);
            box-shadow: 0 2px 0 #9e691f;
        }

        /* artifact popup */
        .artifact-card {
            max-width: 420px;
            width: 100%;
            background: linear-gradient(165deg, #4a2e1e, #6b4a2e);
            border-radius: 70px;
            padding: 40px 25px 45px;
            box-shadow: 0 30px 50px #000000cc, 0 0 0 8px #ffd966;
            text-align: center;
            animation: glowPulse 2s infinite alternate;
            border: 3px solid #ffb347;
            margin: auto;
        }

        @keyframes glowPulse {
            from { box-shadow: 0 30px 50px #000000cc, 0 0 0 8px #ffd966; }
            to { box-shadow: 0 30px 60px #000000, 0 0 0 12px #ffaa33; }
        }

        .artifact-emoji {
            font-size: 120px;
            line-height: 1.2;
            margin: 15px 0;
            filter: drop-shadow(8px 15px 0 #3f2b16);
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
            100% { transform: translateY(0px); }
        }

        .artifact-title {
            font-size: 58px;
            font-weight: 900;
            color: #ffecb3;
            text-transform: uppercase;
            letter-spacing: 4px;
            text-shadow: 5px 5px 0 #7a4c1d;
            margin: 10px 0;
            line-height: 1.2;
        }

        .artifact-sub {
            font-size: 24px;
            color: #ffe39a;
            background: #3d2b17;
            padding: 15px 20px;
            border-radius: 60px;
            margin: 25px 0 15px;
            border: 2px solid #e5a449;
        }

        .artifact-tap {
            font-size: 20px;
            color: #ffdb9f;
            margin-top: 30px;
            opacity: 0.9;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }

        /* leaderboard popup - scrollable */
        .leaderboard-card {
            max-width: 480px;
            width: 100%;
            max-height: 90vh;
            background: linear-gradient(165deg, #1e3b4a, #16323f);
            border-radius: 50px;
            padding: 20px 18px 22px;
            box-shadow: 0 25px 45px #000000, 0 0 0 6px #c9ae5b;
            text-align: center;
            border: 2px solid #dbb45c;
            animation: pop 0.3s ease-out;
            margin: auto;
            display: flex;
            flex-direction: column;
        }

        .stats-row {
            display: flex;
            justify-content: space-around;
            background: #0e2938;
            border-radius: 40px;
            padding: 12px 10px;
            margin: 10px 0 15px;
            border: 2px solid #b8944a;
            flex-shrink: 0;
        }

        .stat-item {
            text-align: center;
            color: white;
            min-width: 70px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 800;
            color: #ffdb8e;
            line-height: 1.2;
        }

        .stat-label {
            font-size: 13px;
            color: #acccdd;
            text-transform: uppercase;
        }

        .score-highlight {
            background: #f5b342;
            border-radius: 60px;
            padding: 15px;
            margin: 5px 0 10px;
            border: 3px solid gold;
            box-shadow: 0 0 20px gold;
            flex-shrink: 0;
        }

        .score-title {
            font-size: 16px;
            color: #1e3a4a;
            font-weight: 600;
            letter-spacing: 1px;
        }

        .score-number {
            font-size: 52px;
            font-weight: 900;
            color: #1f2e3a;
            line-height: 1.1;
            text-shadow: 2px 2px 0 #ffdb8e;
        }

        .score-rating {
            font-size: 24px;
            font-weight: 800;
            color: #1f2e3a;
        }

        .leaderboard-title {
            font-size: 24px;
            font-weight: 800;
            color: #ffdfa0;
            margin: 5px 0 10px;
            letter-spacing: 1px;
            flex-shrink: 0;
        }

        /* Scrollable leaderboard list */
        .leaderboard-list {
            background: #0c202b;
            border-radius: 30px;
            padding: 12px;
            margin: 5px 0 10px;
            border: 2px solid #aa873f;
            overflow-y: auto;
            flex-grow: 1;
            min-height: 200px;
            max-height: 350px;
            scrollbar-width: thin;
            scrollbar-color: #c9ae5b #1d3f4f;
        }

        /* Custom scrollbar for webkit */
        .leaderboard-list::-webkit-scrollbar {
            width: 6px;
        }

        .leaderboard-list::-webkit-scrollbar-track {
            background: #1d3f4f;
            border-radius: 10px;
        }

        .leaderboard-list::-webkit-scrollbar-thumb {
            background: #c9ae5b;
            border-radius: 10px;
        }

        .leaderboard-list::-webkit-scrollbar-thumb:hover {
            background: #e5c87c;
        }

        .leaderboard-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 15px;
            margin: 4px 0;
            background: #1d3f4f;
            border-radius: 40px;
            font-size: 16px;
            font-weight: 600;
            color: white;
            transition: all 0.1s;
        }

        /* Highlight player's position */
        .leaderboard-row.you {
            background: #c9a34b;
            color: #0a1f29;
            font-weight: 800;
            border: 2px solid gold;
            box-shadow: 0 0 15px gold;
            transform: scale(1.02);
            position: relative;
            z-index: 2;
        }

        .rank {
            min-width: 35px;
            font-size: 15px;
        }

        .player-name {
            flex: 1;
            text-align: left;
            padding-left: 8px;
            font-size: 15px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 130px;
        }

        .score {
            font-weight: 700;
            color: #ffd966;
            font-size: 15px;
            min-width: 55px;
            text-align: right;
        }

        .you .score {
            color: #2d1905;
        }

        .rating-badge {
            font-size: 14px;
            margin-left: 6px;
            min-width: 55px;
            text-align: right;
            padding: 3px 6px;
            border-radius: 20px;
            background: rgba(0,0,0,0.3);
        }

        .you .rating-badge {
            background: rgba(255,215,0,0.3);
        }

        .leaderboard-footer {
            font-size: 16px;
            color: #ffdcaa;
            margin: 10px 0 8px;
            font-weight: 500;
            flex-shrink: 0;
        }

        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 12px;
            flex-shrink: 0;
        }

        .action-btn {
            flex: 1;
            background: #f0b345;
            border: none;
            border-radius: 40px;
            padding: 14px 10px;
            font-weight: 700;
            font-size: 20px;
            color: #1d332b;
            box-shadow: 0 5px 0 #9e691f;
            cursor: pointer;
            border: 2px solid #ffe694;
            transition: 0.08s;
        }

        .action-btn:active {
            transform: translateY(4px);
            box-shadow: 0 1px 0 #9e691f;
        }

        .action-btn.secondary {
            background: #557a8b;
            box-shadow: 0 5px 0 #2e4a57;
            color: white;
        }

        .hidden {
            display: none !important;
        }

        /* artifact area */
        .artifact-box {
            background: #1d3643;
            border-radius: 32px;
            margin: 15px 0 10px;
            padding: 14px 20px;
            color: #ffeec2;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 24px;
            font-weight: 700;
            border: 2px solid #c5a15b;
        }

        .artifact-icon {
            font-size: 44px;
            filter: drop-shadow(0 4px 2px black);
        }

        .telegram-footer {
            font-size: 14px;
            text-align: center;
            color: #aac3d0;
            margin-top: 20px;
        }

        /* Responsive adjustments */
        @media (max-height: 700px) {
            .leaderboard-card {
                padding: 15px 15px 18px;
            }
            
            .stats-row {
                padding: 8px 5px;
                margin: 5px 0 10px;
            }
            
            .stat-value {
                font-size: 24px;
            }
            
            .score-number {
                font-size: 42px;
            }
            
            .leaderboard-row {
                padding: 5px 12px;
                font-size: 14px;
            }
            
            .leaderboard-list {
                min-height: 150px;
            }
        }
    </style>
</head>
<body>
<div class="game-container" id="gameContainer">
    <!-- header -->
    <div class="header">
        <span class="title">‚öíÔ∏è SPELLFORGE</span>
        <span class="progress-badge" id="progressDisplay">0/20</span>
    </div>

    <!-- word list -->
    <div class="word-section">
        <div class="section-label">üìã WORDS TO FORGE ¬∑ tap any to start</div>
        <div class="word-grid" id="wordListContainer"></div>
    </div>

    <!-- active word hint -->
    <div class="active-hint" id="activeHintArea">
        <span class="target-word" id="activeWordDisplay">‚Äî</span>
        <span class="next-letter" id="nextLetterDisplay">?</span>
    </div>

    <!-- letter grid -->
    <div class="letter-section">
        <div class="section-label">üî§ LETTER FORGE ¬∑ tap in order</div>
        <div class="letter-grid" id="letterGridContainer"></div>
    </div>

    <!-- artifact progress -->
    <div class="artifact-box" id="artifactBox">
        <span class="artifact-icon">üèÜ</span>
        <span id="artifactText">LOCKED</span>
        <span>‚öíÔ∏è</span>
    </div>

    <!-- reset button -->
    <button class="reset-btn" id="resetButton">üîÑ FORGE AGAIN</button>
    <div class="telegram-footer">Telegram Mini App ¬∑ forge words to unlock</div>
</div>

<!-- popup overlay (handles all popups) -->
<div id="popupOverlay" class="popup-overlay hidden">
    <!-- This will be dynamically populated -->
</div>

<script>
    (function() {
        // ---------- TELEGRAM WEB APP INTEGRATION ----------
        let tg = window.Telegram?.WebApp;
        if (tg) {
            tg.expand();
            tg.enableClosingConfirmation?.();
            tg.setHeaderColor?.('#1a2f3f');
        }

        // ---------- WORD DATABASE ----------
        const wordsDatabase = [
            { word: "alien", emoji: "üëΩ", sentence: "The friendly alien played guitar with astronauts." },
            { word: "among", emoji: "üïµÔ∏è", sentence: "A red mushroom stood among the green ferns." },
            { word: "chart", emoji: "üìä", sentence: "We made a chart of everyone's favorite pizza." },
            { word: "cloud", emoji: "‚òÅÔ∏è", sentence: "That cloud looks exactly like a dragon." },
            { word: "comprehend", emoji: "üß†", sentence: "It's hard to comprehend how big the universe is." },
            { word: "describe", emoji: "üó£Ô∏è", sentence: "Can you describe your perfect day?" },
            { word: "ever", emoji: "üåü", sentence: "This is the most beautiful sunset ever." },
            { word: "fail", emoji: "üò§", sentence: "It's okay to fail when you're learning something new." },
            { word: "friendly", emoji: "üêï", sentence: "The friendly dog wagged its tail at everyone." },
            { word: "grade", emoji: "üìù", sentence: "She got an A+ on her spelling grade." },
            { word: "instead", emoji: "üîÑ", sentence: "Let's play outside instead of watching TV." },
            { word: "library", emoji: "üìö", sentence: "The library has a story hour every Tuesday." },
            { word: "planet", emoji: "ü™ê", sentence: "Which planet has the most beautiful rings?" },
            { word: "report", emoji: "üì∞", sentence: "I need to write a report about frogs." },
            { word: "several", emoji: "üßÆ", sentence: "I've read several books by that author." },
            { word: "solve", emoji: "üß©", sentence: "Together we can solve any puzzle." },
            { word: "suddenly", emoji: "‚ö°", sentence: "Suddenly, the room filled with colorful light." },
            { word: "suppose", emoji: "ü§î", sentence: "I suppose we could share the last cookie." },
            { word: "universe", emoji: "üåå", sentence: "How many stars are in the universe?" },
            { word: "view", emoji: "üèûÔ∏è", sentence: "The view from the mountain was incredible." }
        ];

        // ---------- GAME STATE ----------
        let currentLetters = [];
        let completedWords = [];
        let activeWordIndex = null;
        let currentPosition = 0;
        let allWords = wordsDatabase.map(w => w.word);
        
        // Stats tracking
        let gameStartTime = null;
        let totalTaps = 0;
        let correctTaps = 0;
        let gameCompleted = false;

        // Queue for word cards
        let wordCardQueue = [];
        let showingWordCard = false;

        // ---------- SPELLFORGE RATING (SFR) SYSTEM ----------
        function calculateSFR(timeSeconds, accuracy, totalTapsCount, correctTapsCount) {
            // Base score from accuracy (max 200)
            const accuracyScore = Math.round(accuracy * 2);
            
            // Speed score: 100000 / time in seconds (faster = higher)
            // Prevents division by zero
            const speedScore = timeSeconds > 0 ? Math.round(100000 / timeSeconds) : 2000;
            
            // Perfection bonus for 100% accuracy AND no wrong taps
            const perfectionBonus = (accuracy === 100 && totalTapsCount === correctTapsCount) ? 100 : 0;
            
            // Streak bonus placeholder (could be expanded later)
            const streakBonus = 0;
            
            // Calculate total
            let total = accuracyScore + speedScore + perfectionBonus + streakBonus;
            
            // Cap at reasonable max (world record pace: ~1:20 perfect = ~1450)
            total = Math.min(total, 1600);
            
            return total;
        }

        function getRatingFromScore(score) {
            if (score >= 1400) return { title: "LEGEND", emoji: "üî•", color: "#ffd700" };
            if (score >= 1200) return { title: "MASTER", emoji: "üëë", color: "#c0c0c0" };
            if (score >= 1000) return { title: "EXPERT", emoji: "‚ö°", color: "#cd7f32" };
            if (score >= 800) return { title: "ADVANCED", emoji: "üõ°Ô∏è", color: "#4a90e2" };
            if (score >= 600) return { title: "INTERMEDIATE", emoji: "üìò", color: "#50c878" };
            return { title: "NOVICE", emoji: "üå±", color: "#ffffff" };
        }

        // ---------- MOCK LEADERBOARD WITH SFR ----------
        const mockLeaderboard = [
            { name: "LIAM", score: 1420, time: "1:24", accuracy: 98, rank: 1 },
            { name: "ELENA", score: 1380, time: "1:28", accuracy: 99, rank: 2 },
            { name: "NOAH", score: 1350, time: "1:31", accuracy: 97, rank: 3 },
            { name: "SOFIA", score: 1310, time: "1:35", accuracy: 98, rank: 4 },
            { name: "OLIVER", score: 1280, time: "1:38", accuracy: 96, rank: 5 },
            { name: "MIA", score: 1240, time: "1:42", accuracy: 97, rank: 6 },
            { name: "LUCAS", score: 1210, time: "1:45", accuracy: 95, rank: 7 },
            { name: "AMELIA", score: 1180, time: "1:48", accuracy: 96, rank: 8 },
            { name: "ELIJAH", score: 1150, time: "1:51", accuracy: 94, rank: 9 },
            { name: "HARPER", score: 1120, time: "1:54", accuracy: 95, rank: 10 },
            { name: "JAMES", score: 1090, time: "1:57", accuracy: 93, rank: 11 },
            { name: "EVELYN", score: 1060, time: "2:00", accuracy: 94, rank: 12 },
            { name: "BENJAMIN", score: 1030, time: "2:03", accuracy: 92, rank: 13 },
            { name: "ABIGAIL", score: 1000, time: "2:06", accuracy: 93, rank: 14 },
            { name: "ALEXANDER", score: 970, time: "2:09", accuracy: 91, rank: 15 },
            { name: "ELIZABETH", score: 940, time: "2:12", accuracy: 92, rank: 16 },
            { name: "HENRY", score: 910, time: "2:15", accuracy: 90, rank: 17 },
            { name: "SOPHIA", score: 880, time: "2:18", accuracy: 91, rank: 18 },
            { name: "DANIEL", score: 850, time: "2:21", accuracy: 89, rank: 19 },
            { name: "CHARLOTTE", score: 820, time: "2:24", accuracy: 90, rank: 20 },
            { name: "MATTHEW", score: 790, time: "2:27", accuracy: 88, rank: 21 },
            { name: "AVA", score: 760, time: "2:30", accuracy: 89, rank: 22 },
            { name: "JACKSON", score: 730, time: "2:33", accuracy: 87, rank: 23 },
            { name: "SCARLETT", score: 700, time: "2:36", accuracy: 88, rank: 24 },
            { name: "SEBASTIAN", score: 670, time: "2:39", accuracy: 86, rank: 25 },
            { name: "GRACE", score: 640, time: "2:42", accuracy: 87, rank: 26 },
            { name: "DAVID", score: 610, time: "2:45", accuracy: 85, rank: 27 },
            { name: "CHLOE", score: 580, time: "2:48", accuracy: 86, rank: 28 },
            { name: "JOSEPH", score: 550, time: "2:51", accuracy: 84, rank: 29 },
            { name: "VICTORIA", score: 520, time: "2:54", accuracy: 85, rank: 30 },
            { name: "SAMUEL", score: 490, time: "2:57", accuracy: 83, rank: 31 },
            { name: "LILY", score: 460, time: "3:00", accuracy: 84, rank: 32 }
        ];

        // We'll insert YOU dynamically with actual score later

        // ---------- HELPER FUNCTIONS ----------
        function generateInitialLetters() {
            let allChars = [];
            wordsDatabase.forEach(entry => {
                allChars.push(...entry.word.split(''));
            });
            // scramble
            for (let i = allChars.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [allChars[i], allChars[j]] = [allChars[j], allChars[i]];
            }
            return allChars;
        }

        function getWordData(idx) {
            return wordsDatabase[idx];
        }

        function isGameComplete() {
            return completedWords.length === allWords.length;
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function calculateAccuracy() {
            if (totalTaps === 0) return 100;
            return Math.round((correctTaps / totalTaps) * 100);
        }

        // ---------- POPUP FUNCTIONS ----------
        function showWordCard(wordData) {
            wordCardQueue.push(wordData);
            processWordCardQueue();
        }

        function processWordCardQueue() {
            if (showingWordCard || wordCardQueue.length === 0) return;
            
            showingWordCard = true;
            const wordData = wordCardQueue.shift();
            
            const overlay = document.getElementById('popupOverlay');
            overlay.innerHTML = '';
            
            const card = document.createElement('div');
            card.className = 'word-card';
            card.innerHTML = `
                <div class="word-emoji">${wordData.emoji}</div>
                <div class="word-title">${wordData.word.toUpperCase()}</div>
                <div class="word-sentence">${wordData.sentence}</div>
                <button class="collect-btn" id="collectWordBtn">‚ú® COLLECT</button>
            `;
            
            overlay.appendChild(card);
            overlay.classList.remove('hidden');
            
            document.getElementById('collectWordBtn').addEventListener('click', () => {
                overlay.classList.add('hidden');
                showingWordCard = false;
                
                // Check if game is complete
                if (isGameComplete() && !gameCompleted) {
                    gameCompleted = true;
                    setTimeout(() => {
                        showArtifactPopup();
                    }, 300);
                } else {
                    processWordCardQueue();
                }
            });
            
            tg?.HapticFeedback?.notificationOccurred?.('success');
        }

        function showArtifactPopup() {
            const overlay = document.getElementById('popupOverlay');
            overlay.innerHTML = '';
            
            const artifactCard = document.createElement('div');
            artifactCard.className = 'artifact-card';
            artifactCard.innerHTML = `
                <div class="artifact-emoji">üîÆ</div>
                <div class="artifact-title">ARTIFACT</div>
                <div class="artifact-title">UNLOCKED!</div>
                <div class="artifact-sub">WORD CRYSTAL</div>
                <div class="artifact-tap">‚ú® tap anywhere to continue ‚ú®</div>
            `;
            
            overlay.appendChild(artifactCard);
            overlay.classList.remove('hidden');
            
            // Tap anywhere to continue
            artifactCard.addEventListener('click', (e) => {
                e.stopPropagation();
                showLeaderboardPopup();
            });
            
            tg?.HapticFeedback?.notificationOccurred?.('success');
        }

        function showLeaderboardPopup() {
            const overlay = document.getElementById('popupOverlay');
            
            // Calculate player's SFR
            const timeElapsed = gameStartTime ? Math.floor((Date.now() - gameStartTime) / 1000) : 0;
            const accuracy = calculateAccuracy();
            const playerSFR = calculateSFR(timeElapsed, accuracy, totalTaps, correctTaps);
            const playerRating = getRatingFromScore(playerSFR);
            
            // Create a fresh leaderboard with player inserted
            const leaderboardWithPlayer = [...mockLeaderboard];
            
            // Find where to insert YOU based on score
            const yourEntry = {
                name: "YOU",
                score: playerSFR,
                time: formatTime(timeElapsed),
                accuracy: accuracy,
                rank: 0 // Will set after sorting
            };
            
            // Add YOU to leaderboard
            leaderboardWithPlayer.push(yourEntry);
            
            // Sort by score (highest first)
            leaderboardWithPlayer.sort((a, b) => b.score - a.score);
            
            // Re-assign ranks
            leaderboardWithPlayer.forEach((entry, index) => {
                entry.rank = index + 1;
            });
            
            // Build leaderboard HTML
            let leaderboardHtml = '';
            leaderboardWithPlayer.forEach(entry => {
                const youClass = entry.name === 'YOU' ? ' you' : '';
                const rating = entry.name === 'YOU' ? playerRating : getRatingFromScore(entry.score);
                
                let crownEmoji = '';
                if (entry.rank === 1) crownEmoji = 'üëë';
                else if (entry.rank === 2) crownEmoji = '‚ö°';
                else if (entry.rank === 3) crownEmoji = 'ü•â';
                
                leaderboardHtml += `
                    <div class="leaderboard-row${youClass}" data-rank="${entry.rank}">
                        <span class="rank">${entry.rank}.</span>
                        <span class="player-name">${entry.name}</span>
                        <span class="score">${entry.score}</span>
                        <span class="rating-badge">${rating.emoji} ${rating.title}</span>
                        <span class="crown">${crownEmoji}</span>
                    </div>
                `;
            });

            // Get your rank
            const yourRank = leaderboardWithPlayer.find(e => e.name === 'YOU').rank;
            
            const leaderboardCard = document.createElement('div');
            leaderboardCard.className = 'leaderboard-card';
            leaderboardCard.innerHTML = `
                <div class="leaderboard-title">‚öíÔ∏è FORGE COMPLETE</div>
                
                <div class="score-highlight">
                    <div class="score-title">SPELLFORGE RATING (SFR)</div>
                    <div class="score-number">${playerSFR}</div>
                    <div class="score-rating">${playerRating.emoji} ${playerRating.title}</div>
                </div>
                
                <div class="stats-row">
                    <div class="stat-item">
                        <div class="stat-value">${formatTime(timeElapsed)}</div>
                        <div class="stat-label">TIME</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${accuracy}%</div>
                        <div class="stat-label">ACCURACY</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${correctTaps}/${totalTaps}</div>
                        <div class="stat-label">TAPS</div>
                    </div>
                </div>

                <div class="leaderboard-title">üèÜ SFR LEADERBOARD ¬∑ ${leaderboardWithPlayer.length} PLAYERS</div>
                <div class="leaderboard-list" id="leaderboardList">
                    ${leaderboardHtml}
                </div>

                <div class="leaderboard-footer">
                    You're #${yourRank} of ${leaderboardWithPlayer.length}!
                    ${yourRank === 1 ? ' üèÜ CHAMPION!' : yourRank <= 3 ? ' ‚ö° PODIUM FINISH!' : ''}
                </div>

                <div class="button-group">
                    <button class="action-btn" id="playAgainBtn">‚öíÔ∏è FORGE AGAIN</button>
                    <button class="action-btn secondary" id="shareBtn">üì§ SHARE</button>
                </div>
            `;
            
            overlay.innerHTML = '';
            overlay.appendChild(leaderboardCard);
            
            // Auto-scroll to player's position
            setTimeout(() => {
                const leaderboardList = document.getElementById('leaderboardList');
                const yourRow = leaderboardList.querySelector('.leaderboard-row.you');
                if (yourRow) {
                    yourRow.scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });
                }
            }, 100);
            
            // Attach button listeners
            document.getElementById('playAgainBtn').addEventListener('click', () => {
                overlay.classList.add('hidden');
                resetGame();
            });

            document.getElementById('shareBtn').addEventListener('click', () => {
                const text = `I forged all 20 words in Spellforge with a score of ${playerSFR} SFR (${playerRating.title})! Rank #${yourRank} of ${leaderboardWithPlayer.length}! üîÆ‚öíÔ∏è`;
                
                if (tg) {
                    tg.shareToStory?.(text);
                } else {
                    alert('Share: ' + text);
                }
            });
        }

        // ---------- GAME MECHANICS ----------
        function resetGame() {
            currentLetters = generateInitialLetters();
            completedWords = [];
            activeWordIndex = null;
            currentPosition = 0;
            gameStartTime = Date.now();
            totalTaps = 0;
            correctTaps = 0;
            gameCompleted = false;
            wordCardQueue = [];
            showingWordCard = false;
            document.getElementById('popupOverlay').classList.add('hidden');
            renderAll();
        }

        function handleWordCompletion(completedIdx) {
            if (!completedWords.includes(completedIdx)) {
                completedWords.push(completedIdx);
            }

            // Show word card popup
            const wordData = getWordData(completedIdx);
            showWordCard(wordData);

            // Deactivate word
            activeWordIndex = null;
            currentPosition = 0;

            renderAll();
        }

        function handleLetterTap(letter, indexInGrid) {
            if (gameCompleted) return;
            
            totalTaps++;
            
            if (activeWordIndex === null) {
                tg?.HapticFeedback?.notificationOccurred?.('warning');
                return;
            }
            
            if (completedWords.includes(activeWordIndex)) {
                activeWordIndex = null;
                currentPosition = 0;
                renderAll();
                return;
            }

            const targetWord = allWords[activeWordIndex];
            const neededLetter = targetWord[currentPosition];

            if (letter.toLowerCase() !== neededLetter.toLowerCase()) {
                tg?.HapticFeedback?.notificationOccurred?.('error');
                renderAll();
                return;
            }

            // Correct tap
            correctTaps++;
            currentLetters.splice(indexInGrid, 1);
            currentPosition++;
            
            tg?.HapticFeedback?.impactOccurred?.('light');
            renderAll();

            if (currentPosition === targetWord.length) {
                handleWordCompletion(activeWordIndex);
            }
        }

        // ---------- RENDER UI ----------
        function renderAll() {
            // Word list
            const wordContainer = document.getElementById('wordListContainer');
            wordContainer.innerHTML = '';
            allWords.forEach((w, idx) => {
                const chip = document.createElement('div');
                chip.className = 'word-chip';
                if (completedWords.includes(idx)) {
                    chip.classList.add('completed');
                } else if (activeWordIndex === idx) {
                    chip.classList.add('active-word');
                }
                chip.innerText = w;
                chip.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (completedWords.includes(idx) || gameCompleted) return;
                    activeWordIndex = idx;
                    currentPosition = 0;
                    renderAll();
                    tg?.HapticFeedback?.selectionChanged?.();
                });
                wordContainer.appendChild(chip);
            });

            // Active hint
            if (activeWordIndex !== null && !completedWords.includes(activeWordIndex) && !gameCompleted) {
                const w = allWords[activeWordIndex];
                const progressWord = w.split('').map((l, i) => i < currentPosition ? l.toUpperCase() : '_').join(' ');
                document.getElementById('activeWordDisplay').innerText = progressWord || '‚Äî';
                const nextChar = (currentPosition < w.length) ? w[currentPosition].toUpperCase() : '‚úÖ';
                document.getElementById('nextLetterDisplay').innerText = nextChar;
            } else {
                document.getElementById('activeWordDisplay').innerText = '‚Äî';
                document.getElementById('nextLetterDisplay').innerText = '?';
            }

            // Letter grid
            const gridContainer = document.getElementById('letterGridContainer');
            gridContainer.innerHTML = '';
            currentLetters.forEach((letter, idx) => {
                const tile = document.createElement('div');
                tile.className = 'letter-tile';
                tile.innerText = letter.toUpperCase();
                tile.addEventListener('click', (e) => {
                    e.preventDefault();
                    handleLetterTap(letter, idx);
                });
                gridContainer.appendChild(tile);
            });

            // Progress
            document.getElementById('progressDisplay').innerText = `${completedWords.length}/${allWords.length}`;
            
            // Artifact text
            const artifactEl = document.getElementById('artifactText');
            if (completedWords.length === allWords.length) {
                artifactEl.innerText = 'üåü ARTIFACT UNLOCKED! üåü';
            } else {
                artifactEl.innerText = `üîí LOCKED (${completedWords.length}/${allWords.length})`;
            }
        }

        // ---------- RESET WITH CONFIRMATION ----------
        function confirmReset() {
            if (tg) {
                tg.showConfirm('Restart from beginning? All progress will be lost.', (ok) => {
                    if (ok) {
                        resetGame();
                        tg.HapticFeedback?.impactOccurred?.('heavy');
                    }
                });
            } else {
                if (confirm('Restart from beginning?')) {
                    resetGame();
                }
            }
        }

        // ---------- INITIALIZATION ----------
        document.getElementById('resetButton').addEventListener('click', confirmReset);

        // Start game
        resetGame();

        // Telegram back button
        if (tg) {
            tg.onEvent('backButtonClicked', () => {
                tg.close();
            });
            tg.BackButton?.show();
            tg.ready();
        }
    })();
</script>
</body>
</html>
