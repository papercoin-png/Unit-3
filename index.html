<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spellforge ¬∑ Telegram Mini App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, system-ui, -apple-system, sans-serif;
        }

        body {
            background: linear-gradient(145deg, #1a2f3f 0%, #1e3a4a 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 12px;
            margin: 0;
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(145deg, #1a2f3f, #0f1f29);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            transition: opacity 0.5s ease;
        }

        .loading-screen.fade-out {
            opacity: 0;
            pointer-events: none;
        }

        .loading-content {
            max-width: 400px;
            width: 90%;
            text-align: center;
            padding: 20px;
        }

        .loading-image {
            width: 100%;
            max-width: 300px;
            height: auto;
            border-radius: 30px;
            margin-bottom: 25px;
            box-shadow: 0 20px 30px rgba(0,0,0,0.5);
            border: 3px solid #c9ae5b;
            animation: glowPulse 2s infinite alternate;
        }

        .loading-title {
            font-size: 36px;
            font-weight: 800;
            color: #ffdfa0;
            margin-bottom: 30px;
            letter-spacing: 2px;
            text-shadow: 3px 3px 0 #7a4c1d;
        }

        .loading-bar-container {
            width: 100%;
            height: 20px;
            background: #0c202b;
            border-radius: 30px;
            border: 2px solid #aa873f;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .loading-bar {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, #f0b345, #ffd966);
            border-radius: 30px;
            transition: width 0.3s ease;
            box-shadow: 0 0 10px #ffaa33;
        }

        .loading-text {
            font-size: 18px;
            color: #ffdcaa;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .loading-tip {
            font-size: 16px;
            color: #acccdd;
            font-style: italic;
            padding: 15px;
            background: rgba(0,0,0,0.3);
            border-radius: 30px;
            border-left: 4px solid #c9ae5b;
        }

        .game-container {
            max-width: 550px;
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 42px;
            padding: 24px 20px 30px;
            box-shadow: 0 25px 40px -10px rgba(0, 0, 0, 0.5);
            transition: all 0.2s;
        }

        /* header with world info */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            color: white;
            padding: 0 5px;
        }

        .world-info {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(0,0,0,0.3);
            padding: 8px 16px;
            border-radius: 60px;
            border: 1px solid rgba(255,215,140,0.3);
        }

        .world-icon {
            font-size: 24px;
        }

        .world-name {
            font-weight: 700;
            font-size: 18px;
            color: #ffefc0;
        }

        .title {
            font-weight: 700;
            font-size: 26px;
            letter-spacing: 1px;
            background: linear-gradient(135deg, #ffe99c, #ffd78c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        .progress-badge {
            background: rgba(255, 215, 140, 0.25);
            border: 1px solid rgba(255, 235, 150, 0.6);
            border-radius: 60px;
            padding: 8px 16px;
            font-weight: 600;
            font-size: 18px;
            color: #ffefc0;
            backdrop-filter: blur(4px);
        }

        /* word list area */
        .word-section {
            background: rgba(10, 25, 35, 0.7);
            border-radius: 38px;
            padding: 18px 15px;
            margin-bottom: 22px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.4);
        }

        .section-label {
            color: #b6d8e6;
            font-size: 15px;
            font-weight: 500;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            padding-left: 8px;
        }

        .word-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            max-height: 200px;
            overflow-y: auto;
            padding: 5px;
            scrollbar-width: thin;
            scrollbar-color: #c9ae5b #1d3f4f;
        }

        .word-grid::-webkit-scrollbar {
            width: 6px;
        }

        .word-grid::-webkit-scrollbar-track {
            background: #1d3f4f;
            border-radius: 10px;
        }

        .word-grid::-webkit-scrollbar-thumb {
            background: #c9ae5b;
            border-radius: 10px;
        }

        .word-chip {
            background: #2c4556;
            border-radius: 40px;
            padding: 12px 22px;
            font-weight: 600;
            font-size: 18px;
            color: #c9e9ff;
            box-shadow: 0 6px 0 #0f1f29, 0 8px 10px rgba(0,0,0,0.3);
            transition: all 0.1s ease;
            border: 1px solid #598baa;
            user-select: none;
            cursor: pointer;
            min-width: 90px;
            text-align: center;
        }

        .word-chip.completed {
            background: #3f6a4a;
            color: #d9ffd9;
            border-color: #a5d6a5;
            box-shadow: 0 4px 0 #1b3b24, 0 6px 8px rgba(0,0,0,0.3);
            text-decoration: line-through 2px rgba(255,255,255,0.4);
            opacity: 0.8;
            cursor: default;
            pointer-events: none;
        }

        .word-chip.active-word {
            background: #f5c542;
            color: #1e2f3a;
            border-color: #ffea9e;
            box-shadow: 0 0 0 3px #fce49c, 0 6px 0 #a07d2b;
            transform: scale(1.02);
            font-weight: 800;
        }

        /* unit selector */
        .unit-section {
            background: rgba(10, 25, 35, 0.7);
            border-radius: 38px;
            padding: 18px 15px;
            margin-bottom: 22px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.4);
        }

        .unit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 0 8px;
        }

        .unit-label {
            color: #b6d8e6;
            font-size: 15px;
            font-weight: 500;
            letter-spacing: 0.5px;
        }

        .unit-selector {
            background: #1d3f4f;
            border: 2px solid #b8944a;
            border-radius: 40px;
            padding: 8px 16px;
            color: #ffdb8e;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            outline: none;
        }

        .unit-selector option {
            background: #1d3f4f;
            color: white;
        }

        .unit-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            max-height: 200px;
            overflow-y: auto;
            padding: 5px;
            scrollbar-width: thin;
            scrollbar-color: #c9ae5b #1d3f4f;
        }

        .unit-grid::-webkit-scrollbar {
            width: 6px;
        }

        .unit-grid::-webkit-scrollbar-track {
            background: #1d3f4f;
            border-radius: 10px;
        }

        .unit-grid::-webkit-scrollbar-thumb {
            background: #c9ae5b;
            border-radius: 10px;
        }

        .unit-card {
            background: #2c4556;
            border-radius: 30px;
            padding: 12px 15px;
            min-width: 140px;
            flex: 1 0 auto;
            max-width: 160px;
            border: 2px solid #598baa;
            box-shadow: 0 4px 0 #0f1f29;
            cursor: pointer;
            transition: all 0.1s;
        }

        .unit-card.active-unit {
            background: #f5c542;
            border-color: #ffea9e;
            box-shadow: 0 0 0 3px #fce49c, 0 4px 0 #a07d2b;
        }

        .unit-card.completed {
            background: #3f6a4a;
            border-color: #a5d6a5;
            opacity: 0.8;
        }

        .unit-number {
            font-size: 14px;
            color: #acccdd;
            margin-bottom: 4px;
        }

        .unit-name {
            font-weight: 700;
            font-size: 18px;
            color: white;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .active-unit .unit-name {
            color: #1e2f3a;
        }

        .unit-progress {
            font-size: 14px;
            color: #ffdb8e;
        }

        .unit-progress-bar {
            width: 100%;
            height: 6px;
            background: #0f1f29;
            border-radius: 10px;
            margin-top: 8px;
            overflow: hidden;
        }

        .unit-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #f0b345, #ffd966);
            border-radius: 10px;
            transition: width 0.3s;
        }

        /* active word hint */
        .active-hint {
            background: #244454;
            border-radius: 30px;
            padding: 15px 18px;
            margin: 18px 0 10px;
            text-align: center;
            border-left: 8px solid #f5c542;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .target-word {
            font-size: 26px;
            font-weight: 700;
            letter-spacing: 6px;
            color: #ffea9a;
        }

        .next-letter {
            background: #f5c542;
            color: #1f2e3a;
            padding: 8px 25px;
            border-radius: 50px;
            font-weight: 700;
            font-size: 24px;
            min-width: 70px;
            text-align: center;
            box-shadow: 0 4px 0 #946f2c;
        }

        /* letter bank */
        .letter-section {
            background: rgba(10, 25, 35, 0.7);
            border-radius: 38px;
            padding: 18px 12px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .letter-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
        }

        .letter-tile {
            width: 62px;
            height: 62px;
            background: linear-gradient(145deg, #ffcf8a, #febf6e);
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 34px;
            color: #1f3b4a;
            box-shadow: 0 9px 0 #b2752e, 0 10px 18px rgba(0, 0, 0, 0.4);
            transition: all 0.08s linear;
            cursor: pointer;
            border: 2px solid #ffdcaa;
            text-transform: uppercase;
            user-select: none;
        }

        .letter-tile:active {
            transform: translateY(6px);
            box-shadow: 0 3px 0 #b2752e, 0 8px 12px rgba(0,0,0,0.4);
        }

        .letter-tile.used {
            background: #3a4d5e;
            box-shadow: 0 4px 0 #1d2c36, 0 6px 8px rgba(0,0,0,0.3);
            border-color: #5b7485;
            color: #a1b9cc;
            cursor: not-allowed;
            transform: translateY(5px);
            pointer-events: none;
            opacity: 0.5;
        }

        /* reset button */
        .reset-btn {
            background: #334e62;
            border: none;
            border-radius: 60px;
            padding: 18px 25px;
            font-weight: 700;
            font-size: 20px;
            color: #ffefcf;
            box-shadow: 0 8px 0 #1c2f3b, 0 6px 15px black;
            cursor: pointer;
            width: 100%;
            transition: 0.08s;
            border: 1px solid #63879e;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .reset-btn:active {
            transform: translateY(5px);
            box-shadow: 0 3px 0 #1c2f3b, 0 6px 10px black;
        }

        /* popup overlay base */
        .popup-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: all 0.3s;
            padding: 16px;
            box-sizing: border-box;
            overflow-y: auto;
        }

        /* word card - with smaller collect button */
        .word-card {
            max-width: 380px;
            width: 100%;
            background: linear-gradient(165deg, #fff8e7, #ffffff);
            border-radius: 58px;
            padding: 30px 20px;
            box-shadow: 0 30px 50px #00000080, 0 0 0 6px #fad87c;
            text-align: center;
            animation: pop 0.3s cubic-bezier(0.2, 0.9, 0.3, 1.3);
            border: 3px solid #ffcd7e;
            margin: auto;
        }

        @keyframes pop {
            0% { transform: scale(0.7); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .word-emoji {
            font-size: 110px;
            line-height: 1.2;
            margin: 5px 0;
        }

        .word-title {
            font-size: 58px;
            font-weight: 900;
            color: #1f4a5c;
            text-transform: uppercase;
            letter-spacing: 3px;
            text-shadow: 3px 5px 0 #ffcd7e;
            margin: 5px 0;
            word-break: break-word;
        }

        .word-sentence {
            font-size: 22px;
            background: #ebcba0;
            padding: 20px;
            border-radius: 40px;
            color: #1f3a47;
            font-weight: 500;
            margin: 20px 0;
            border: 2px dashed #a5723b;
            word-break: break-word;
        }

        /* 25% smaller collect button */
        .collect-btn {
            background: #f5b342;
            border: none;
            border-radius: 50px;
            padding: 14px;
            font-weight: 700;
            font-size: 22px;
            color: #1f3826;
            box-shadow: 0 5px 0 #9e691f;
            cursor: pointer;
            width: 80%;
            margin: 0 auto;
            display: block;
            border: 2px solid #ffe39b;
            transition: 0.08s;
        }

        .collect-btn:active {
            transform: translateY(3px);
            box-shadow: 0 2px 0 #9e691f;
        }

        /* artifact popup */
        .artifact-card {
            max-width: 420px;
            width: 100%;
            background: linear-gradient(165deg, #4a2e1e, #6b4a2e);
            border-radius: 70px;
            padding: 40px 25px 45px;
            box-shadow: 0 30px 50px #000000cc, 0 0 0 8px #ffd966;
            text-align: center;
            animation: glowPulse 2s infinite alternate;
            border: 3px solid #ffb347;
            margin: auto;
        }

        @keyframes glowPulse {
            from { box-shadow: 0 30px 50px #000000cc, 0 0 0 8px #ffd966; }
            to { box-shadow: 0 30px 60px #000000, 0 0 0 12px #ffaa33; }
        }

        .artifact-emoji {
            font-size: 120px;
            line-height: 1.2;
            margin: 15px 0;
            filter: drop-shadow(8px 15px 0 #3f2b16);
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
            100% { transform: translateY(0px); }
        }

        .artifact-title {
            font-size: 58px;
            font-weight: 900;
            color: #ffecb3;
            text-transform: uppercase;
            letter-spacing: 4px;
            text-shadow: 5px 5px 0 #7a4c1d;
            margin: 10px 0;
            line-height: 1.2;
        }

        .artifact-sub {
            font-size: 24px;
            color: #ffe39a;
            background: #3d2b17;
            padding: 15px 20px;
            border-radius: 60px;
            margin: 25px 0 15px;
            border: 2px solid #e5a449;
        }

        .artifact-tap {
            font-size: 20px;
            color: #ffdb9f;
            margin-top: 30px;
            opacity: 0.9;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }

        /* leaderboard popup - scrollable */
        .leaderboard-card {
            max-width: 480px;
            width: 100%;
            max-height: 90vh;
            background: linear-gradient(165deg, #1e3b4a, #16323f);
            border-radius: 50px;
            padding: 20px 18px 22px;
            box-shadow: 0 25px 45px #000000, 0 0 0 6px #c9ae5b;
            text-align: center;
            border: 2px solid #dbb45c;
            animation: pop 0.3s ease-out;
            margin: auto;
            display: flex;
            flex-direction: column;
        }

        .stats-row {
            display: flex;
            justify-content: space-around;
            background: #0e2938;
            border-radius: 40px;
            padding: 12px 10px;
            margin: 10px 0 15px;
            border: 2px solid #b8944a;
            flex-shrink: 0;
        }

        .stat-item {
            text-align: center;
            color: white;
            min-width: 70px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 800;
            color: #ffdb8e;
            line-height: 1.2;
        }

        .stat-label {
            font-size: 13px;
            color: #acccdd;
            text-transform: uppercase;
        }

        .score-highlight {
            background: #f5b342;
            border-radius: 60px;
            padding: 15px;
            margin: 5px 0 10px;
            border: 3px solid gold;
            box-shadow: 0 0 20px gold;
            flex-shrink: 0;
        }

        .score-title {
            font-size: 16px;
            color: #1e3a4a;
            font-weight: 600;
            letter-spacing: 1px;
        }

        .score-number {
            font-size: 52px;
            font-weight: 900;
            color: #1f2e3a;
            line-height: 1.1;
            text-shadow: 2px 2px 0 #ffdb8e;
        }

        .score-rating {
            font-size: 24px;
            font-weight: 800;
            color: #1f2e3a;
        }

        .leaderboard-title {
            font-size: 24px;
            font-weight: 800;
            color: #ffdfa0;
            margin: 5px 0 10px;
            letter-spacing: 1px;
            flex-shrink: 0;
        }

        /* Scrollable leaderboard list */
        .leaderboard-list {
            background: #0c202b;
            border-radius: 30px;
            padding: 12px;
            margin: 5px 0 10px;
            border: 2px solid #aa873f;
            overflow-y: auto;
            flex-grow: 1;
            min-height: 200px;
            max-height: 350px;
            scrollbar-width: thin;
            scrollbar-color: #c9ae5b #1d3f4f;
        }

        .leaderboard-list::-webkit-scrollbar {
            width: 6px;
        }

        .leaderboard-list::-webkit-scrollbar-track {
            background: #1d3f4f;
            border-radius: 10px;
        }

        .leaderboard-list::-webkit-scrollbar-thumb {
            background: #c9ae5b;
            border-radius: 10px;
        }

        .leaderboard-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 15px;
            margin: 4px 0;
            background: #1d3f4f;
            border-radius: 40px;
            font-size: 16px;
            font-weight: 600;
            color: white;
            transition: all 0.1s;
        }

        .leaderboard-row.you {
            background: #c9a34b;
            color: #0a1f29;
            font-weight: 800;
            border: 2px solid gold;
            box-shadow: 0 0 15px gold;
            transform: scale(1.02);
        }

        .rank {
            min-width: 35px;
            font-size: 15px;
        }

        .player-name {
            flex: 1;
            text-align: left;
            padding-left: 8px;
            font-size: 15px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 130px;
        }

        .score {
            font-weight: 700;
            color: #ffd966;
            font-size: 15px;
            min-width: 55px;
            text-align: right;
        }

        .you .score {
            color: #2d1905;
        }

        .rating-badge {
            font-size: 14px;
            margin-left: 6px;
            min-width: 55px;
            text-align: right;
            padding: 3px 6px;
            border-radius: 20px;
            background: rgba(0,0,0,0.3);
        }

        .you .rating-badge {
            background: rgba(255,215,0,0.3);
        }

        .leaderboard-footer {
            font-size: 16px;
            color: #ffdcaa;
            margin: 10px 0 8px;
            font-weight: 500;
            flex-shrink: 0;
        }

        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 12px;
            flex-shrink: 0;
        }

        .action-btn {
            flex: 1;
            background: #f0b345;
            border: none;
            border-radius: 40px;
            padding: 14px 10px;
            font-weight: 700;
            font-size: 20px;
            color: #1d332b;
            box-shadow: 0 5px 0 #9e691f;
            cursor: pointer;
            border: 2px solid #ffe694;
            transition: 0.08s;
        }

        .action-btn:active {
            transform: translateY(4px);
            box-shadow: 0 1px 0 #9e691f;
        }

        .action-btn.secondary {
            background: #557a8b;
            box-shadow: 0 5px 0 #2e4a57;
            color: white;
        }

        .hidden {
            display: none !important;
        }

        /* artifact area */
        .artifact-box {
            background: #1d3643;
            border-radius: 32px;
            margin: 15px 0 10px;
            padding: 14px 20px;
            color: #ffeec2;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 24px;
            font-weight: 700;
            border: 2px solid #c5a15b;
        }

        .artifact-icon {
            font-size: 44px;
            filter: drop-shadow(0 4px 2px black);
        }

        .telegram-footer {
            font-size: 14px;
            text-align: center;
            color: #aac3d0;
            margin-top: 20px;
        }

        @media (max-height: 700px) {
            .leaderboard-card {
                padding: 15px 15px 18px;
            }
            .stats-row {
                padding: 8px 5px;
                margin: 5px 0 10px;
            }
            .stat-value {
                font-size: 24px;
            }
            .score-number {
                font-size: 42px;
            }
            .word-grid {
                max-height: 150px;
            }
            .unit-grid {
                max-height: 150px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-content">
            <img src="https://i.postimg.cc/TwmzR9V2/grok-image-1772302795443.jpg" 
                 alt="Spellforge" 
                 class="loading-image">
            <div class="loading-title">‚öíÔ∏è SPELLFORGE</div>
            <div class="loading-bar-container">
                <div class="loading-bar" id="loadingBar"></div>
            </div>
            <div class="loading-text" id="loadingText">Loading forge...</div>
            <div class="loading-tip" id="loadingTip">
                "Every word forged strengthens the crystal"
            </div>
        </div>
    </div>

    <div class="game-container" id="gameContainer">
        <!-- header with world info -->
        <div class="header">
            <div class="world-info" id="worldInfo">
                <span class="world-icon" id="worldIcon">‚öíÔ∏è</span>
                <span class="world-name" id="worldName">Grand Forge</span>
            </div>
            <span class="progress-badge" id="progressDisplay">0/600</span>
        </div>

        <!-- unit selector section -->
        <div class="unit-section">
            <div class="unit-header">
                <span class="unit-label" id="unitLabel">INGOTS</span>
                <select class="unit-selector" id="unitSelector">
                    <option value="1">Ingot 01 ¬∑ First Spark</option>
                </select>
            </div>
            <div class="unit-grid" id="unitGrid"></div>
        </div>

        <!-- word list area - with original words -->
        <div class="word-section">
            <div class="section-label">üìã WORDS TO FORGE ¬∑ tap any to start</div>
            <div class="word-grid" id="wordListContainer"></div>
        </div>

        <!-- active word hint -->
        <div class="active-hint" id="activeHintArea">
            <span class="target-word" id="activeWordDisplay">‚Äî</span>
            <span class="next-letter" id="nextLetterDisplay">?</span>
        </div>

        <!-- letter grid -->
        <div class="letter-section">
            <div class="section-label">üî§ LETTER FORGE ¬∑ tap in order</div>
            <div class="letter-grid" id="letterGridContainer"></div>
        </div>

        <!-- artifact progress -->
        <div class="artifact-box" id="artifactBox">
            <span class="artifact-icon">üèÜ</span>
            <span id="artifactText">üîí 0/20</span>
            <span>‚öíÔ∏è</span>
        </div>

        <!-- reset button -->
        <button class="reset-btn" id="resetButton">üîÑ FORGE AGAIN</button>
        <div class="telegram-footer">Telegram Mini App ¬∑ forge words to unlock</div>
    </div>

    <!-- popup overlay -->
    <div id="popupOverlay" class="popup-overlay hidden"></div>

    <script>
        (function() {
            // ---------- TELEGRAM INTEGRATION ----------
            let tg = window.Telegram?.WebApp;
            if (tg) {
                tg.expand();
                tg.enableClosingConfirmation?.();
                tg.setHeaderColor?.('#1a2f3f');
            }

            // ---------- LOADING SCREEN ----------
            const loadingTips = [
                '"Every word forged strengthens the crystal"',
                '"The forge remembers every letter"',
                '"Speed and accuracy forge the strongest words"',
                '"Ancient runes glow brighter with each completion"',
                '"The Word Crystal chooses its master wisely"',
                '"Patience tempers the strongest steel"',
                '"Even legends started as apprentices"',
                '"The guild watches your progress"',
                '"Each ingot tells a story"',
                '"Forgemasters never rush the craft"'
            ];

            document.getElementById('loadingTip').innerText = 
                loadingTips[Math.floor(Math.random() * loadingTips.length)];

            let loadingComplete = false;
            let minimumTimePassed = false;

            function simulateLoading() {
                const loadingScreen = document.getElementById('loadingScreen');
                const loadingBar = document.getElementById('loadingBar');
                const loadingText = document.getElementById('loadingText');
                const loadingTip = document.getElementById('loadingTip');
                
                let progress = 0;
                const interval = setInterval(() => {
                    progress += Math.random() * 15 + 5;
                    
                    if (progress >= 100) {
                        progress = 100;
                        loadingBar.style.width = progress + '%';
                        loadingText.innerText = 'Forge ready!';
                        
                        loadingComplete = true;
                        if (minimumTimePassed) {
                            setTimeout(() => {
                                loadingScreen.classList.add('fade-out');
                                setTimeout(() => {
                                    loadingScreen.style.display = 'none';
                                }, 500);
                            }, 300);
                        }
                        clearInterval(interval);
                    } else {
                        loadingBar.style.width = progress + '%';
                        loadingText.innerText = `Loading forge... ${Math.floor(progress)}%`;
                        
                        if (Math.random() > 0.7) {
                            const randomTip = loadingTips[Math.floor(Math.random() * loadingTips.length)];
                            loadingTip.innerText = randomTip;
                        }
                    }
                }, 200);
            }

            setTimeout(() => {
                minimumTimePassed = true;
                if (loadingComplete) {
                    document.getElementById('loadingScreen').classList.add('fade-out');
                    setTimeout(() => {
                        document.getElementById('loadingScreen').style.display = 'none';
                    }, 500);
                }
            }, 2000);

            window.addEventListener('load', simulateLoading);

            // ---------- ORIGINAL WORD DATABASE (RESTORED) ----------
            const wordsDatabase = [
                { word: "alien", emoji: "üëΩ", sentence: "The friendly alien played guitar with astronauts." },
                { word: "among", emoji: "üïµÔ∏è", sentence: "A red mushroom stood among the green ferns." },
                { word: "chart", emoji: "üìä", sentence: "We made a chart of everyone's favorite pizza." },
                { word: "cloud", emoji: "‚òÅÔ∏è", sentence: "That cloud looks exactly like a dragon." },
                { word: "comprehend", emoji: "üß†", sentence: "It's hard to comprehend how big the universe is." },
                { word: "describe", emoji: "üó£Ô∏è", sentence: "Can you describe your perfect day?" },
                { word: "ever", emoji: "üåü", sentence: "This is the most beautiful sunset ever." },
                { word: "fail", emoji: "üò§", sentence: "It's okay to fail when you're learning something new." },
                { word: "friendly", emoji: "üêï", sentence: "The friendly dog wagged its tail at everyone." },
                { word: "grade", emoji: "üìù", sentence: "She got an A+ on her spelling grade." },
                { word: "instead", emoji: "üîÑ", sentence: "Let's play outside instead of watching TV." },
                { word: "library", emoji: "üìö", sentence: "The library has a story hour every Tuesday." },
                { word: "planet", emoji: "ü™ê", sentence: "Which planet has the most beautiful rings?" },
                { word: "report", emoji: "üì∞", sentence: "I need to write a report about frogs." },
                { word: "several", emoji: "üßÆ", sentence: "I've read several books by that author." },
                { word: "solve", emoji: "üß©", sentence: "Together we can solve any puzzle." },
                { word: "suddenly", emoji: "‚ö°", sentence: "Suddenly, the room filled with colorful light." },
                { word: "suppose", emoji: "ü§î", sentence: "I suppose we could share the last cookie." },
                { word: "universe", emoji: "üåå", sentence: "How many stars are in the universe?" },
                { word: "view", emoji: "üèûÔ∏è", sentence: "The view from the mountain was incredible." }
            ];

            // ---------- WORLD DATA STRUCTURE ----------
            const worlds = {
                1: {
                    id: 1,
                    name: "Grand Forge",
                    icon: "‚öíÔ∏è",
                    unitName: "INGOT",
                    unlocked: true,
                    completed: false,
                    totalWords: 600,
                    units: [
                        // Tier 1: Foundation (1-10)
                        { id: 1, name: "First Spark", wordsCompleted: 0, totalWords: 20, unlocked: true },
                        { id: 2, name: "Kindling", wordsCompleted: 0, totalWords: 20, unlocked: false },
                        { id: 3, name: "Ember", wordsCompleted: 0, totalWords: 20, unlocked: false },
                        { id: 4, name: "Bellows", wordsCompleted: 0, totalWords: 20, unlocked: false },
                        { id: 5, name: "Tongs", wordsCompleted: 0, totalWords: 20, unlocked: false },
                        { id: 6, name: "Hammer", wordsCompleted: 0, totalWords: 20, unlocked: false },
                        { id: 7, name: "Anvil", wordsCompleted: 0, totalWords: 20, unlocked: false },
                        { id: 8, name: "Quench", wordsCompleted: 0, totalWords: 20, unlocked: false },
                        { id: 9, name: "Temper", wordsCompleted: 0, totalWords: 20, unlocked: false },
                        { id: 10, name: "Forgefire", wordsCompleted: 0, totalWords: 20, unlocked: false },
                        // Tier 2: Crafting (11-20)
                        { id: 11, name: "Raw Iron", wordsCompleted: 0, totalWords: 20, unlocked: false },
                        { id: 12, name: "Steel Blend", wordsCompleted: 0, totalWords: 20, unlocked: false },
                        { id: 13, name: "Fold", wordsCompleted: 0, totalWords: 20, unlocked: false },
                        { id: 14, name: "Shape", wordsCompleted: 0, totalWords: 20, unlocked: false },
                        { id: 15, name: "Edge", wordsCompleted: 0, totalWords: 20, unlocked: false },
                        { id: 16, name: "Curve", wordsCompleted: 0, totalWords: 20, unlocked: false },
                        { id: 17, name: "Point", wordsCompleted: 0, totalWords: 20, unlocked: false },
                        { id: 18, name: "Balance", wordsCompleted: 0, totalWords: 20, unlocked: false },
                        { id: 19, name: "Polish", wordsCompleted: 0, totalWords: 20, unlocked: false },
                        { id: 20, name: "Gleam", wordsCompleted: 0, totalWords: 20, unlocked: false },
                        // Tier 3: Masterwork (21-30)
                        { id: 21, name: "Pattern", wordsCompleted: 0, totalWords: 20, unlocked: false },
                        { id: 22, name: "Inlay", wordsCompleted: 0, totalWords: 20, unlocked: false },
                        { id: 23, name: "Filigree", wordsCompleted: 0, totalWords: 20, unlocked: false },
                        { id: 24, name: "Engrave", wordsCompleted: 0, totalWords: 20, unlocked: false },
                        { id: 25, name: "Harden", wordsCompleted: 0, totalWords: 20, unlocked: false },
                        { id: 26, name: "Resilience", wordsCompleted: 0, totalWords: 20, unlocked: false },
                        { id: 27, name: "Legacy", wordsCompleted: 0, totalWords: 20, unlocked: false },
                        { id: 28, name: "Masterpiece", wordsCompleted: 0, totalWords: 20, unlocked: false },
                        { id: 29, name: "Legendary", wordsCompleted: 0, totalWords: 20, unlocked: false },
                        { id: 30, name: "Soulforge", wordsCompleted: 0, totalWords: 20, unlocked: false }
                    ]
                },
                2: {
                    id: 2,
                    name: "Enchanted Forest",
                    icon: "üå≥",
                    unitName: "SEED",
                    unlocked: false,
                    completed: false,
                    totalWords: 600,
                    units: Array.from({ length: 30 }, (_, i) => ({
                        id: i + 31,
                        name: "???",
                        wordsCompleted: 0,
                        totalWords: 20,
                        unlocked: false
                    }))
                },
                3: {
                    id: 3,
                    name: "Crystal Caverns",
                    icon: "üíé",
                    unitName: "GEODE",
                    unlocked: false,
                    completed: false,
                    totalWords: 600,
                    units: Array.from({ length: 30 }, (_, i) => ({
                        id: i + 61,
                        name: "???",
                        wordsCompleted: 0,
                        totalWords: 20,
                        unlocked: false
                    }))
                },
                4: {
                    id: 4,
                    name: "Sky Citadel",
                    icon: "‚òÅÔ∏è",
                    unitName: "CLOUD",
                    unlocked: false,
                    completed: false,
                    totalWords: 600,
                    units: Array.from({ length: 30 }, (_, i) => ({
                        id: i + 91,
                        name: "???",
                        wordsCompleted: 0,
                        totalWords: 20,
                        unlocked: false
                    }))
                },
                5: {
                    id: 5,
                    name: "Dragon's Peak",
                    icon: "üêâ",
                    unitName: "SCALE",
                    unlocked: false,
                    completed: false,
                    totalWords: 600,
                    units: Array.from({ length: 30 }, (_, i) => ({
                        id: i + 121,
                        name: "???",
                        wordsCompleted: 0,
                        totalWords: 20,
                        unlocked: false
                    }))
                },
                6: {
                    id: 6,
                    name: "Star Forge",
                    icon: "‚≠ê",
                    unitName: "STAR",
                    unlocked: false,
                    completed: false,
                    totalWords: 600,
                    units: Array.from({ length: 30 }, (_, i) => ({
                        id: i + 151,
                        name: "???",
                        wordsCompleted: 0,
                        totalWords: 20,
                        unlocked: false
                    }))
                }
            };

            // ---------- GAME STATE ----------
            let currentWorld = 1;
            let currentUnit = 1;
            let currentLetters = [];
            let completedWords = [];
            let activeWordIndex = null;
            let currentPosition = 0;
            
            // Stats tracking
            let gameStartTime = null;
            let totalTaps = 0;
            let correctTaps = 0;
            let gameCompleted = false;

            // Queue for word cards
            let wordCardQueue = [];
            let showingWordCard = false;

            // ---------- HELPER FUNCTIONS ----------
            function generateInitialLetters() {
                let allChars = [];
                wordsDatabase.forEach(entry => {
                    allChars.push(...entry.word.split(''));
                });
                // Shuffle
                for (let i = allChars.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [allChars[i], allChars[j]] = [allChars[j], allChars[i]];
                }
                return allChars;
            }

            function getCurrentUnitWords() {
                return wordsDatabase; // Your original 20 words
            }

            function updateWorldDisplay() {
                const world = worlds[currentWorld];
                document.getElementById('worldIcon').innerText = world.icon;
                document.getElementById('worldName').innerText = world.name;
                document.getElementById('unitLabel').innerText = world.unitName + 'S';
                
                // Update unit selector dropdown
                const selector = document.getElementById('unitSelector');
                selector.innerHTML = '';
                world.units.forEach((unit, index) => {
                    if (unit.unlocked) {
                        const option = document.createElement('option');
                        option.value = unit.id;
                        option.innerText = `${world.unitName} ${unit.id.toString().padStart(2, '0')} ¬∑ ${unit.name}`;
                        if (unit.id === currentUnit) option.selected = true;
                        selector.appendChild(option);
                    }
                });

                // Update unit grid
                const grid = document.getElementById('unitGrid');
                grid.innerHTML = '';
                world.units.forEach(unit => {
                    if (unit.unlocked) {
                        const card = document.createElement('div');
                        card.className = `unit-card ${unit.id === currentUnit ? 'active-unit' : ''} ${unit.wordsCompleted === 20 ? 'completed' : ''}`;
                        card.innerHTML = `
                            <div class="unit-number">${world.unitName} ${unit.id.toString().padStart(2, '0')}</div>
                            <div class="unit-name">${unit.name}</div>
                            <div class="unit-progress">${unit.wordsCompleted}/20</div>
                            <div class="unit-progress-bar">
                                <div class="unit-progress-fill" style="width: ${(unit.wordsCompleted/20)*100}%"></div>
                            </div>
                        `;
                        card.addEventListener('click', () => {
                            if (unit.id !== currentUnit) {
                                currentUnit = unit.id;
                                resetForNewUnit();
                                updateWorldDisplay();
                            }
                        });
                        grid.appendChild(card);
                    }
                });

                // Update total progress
                const totalCompleted = world.units.reduce((sum, unit) => sum + unit.wordsCompleted, 0);
                document.getElementById('progressDisplay').innerText = `${totalCompleted}/${world.totalWords}`;
            }

            function resetForNewUnit() {
                currentLetters = generateInitialLetters();
                completedWords = [];
                activeWordIndex = null;
                currentPosition = 0;
                gameStartTime = Date.now();
                totalTaps = 0;
                correctTaps = 0;
                gameCompleted = false;
                wordCardQueue = [];
                showingWordCard = false;
                renderAll();
            }

            // ---------- SFR SYSTEM ----------
            function calculateSFR(timeSeconds, accuracy, totalTapsCount, correctTapsCount) {
                const accuracyScore = Math.round(accuracy * 2);
                const speedScore = timeSeconds > 0 ? Math.round(100000 / timeSeconds) : 2000;
                const perfectionBonus = (accuracy === 100 && totalTapsCount === correctTapsCount) ? 100 : 0;
                let total = accuracyScore + speedScore + perfectionBonus;
                total = Math.min(total, 1600);
                return total;
            }

            function getRatingFromScore(score) {
                if (score >= 1400) return { title: "LEGEND", emoji: "üî•" };
                if (score >= 1200) return { title: "MASTER", emoji: "üëë" };
                if (score >= 1000) return { title: "EXPERT", emoji: "‚ö°" };
                if (score >= 800) return { title: "ADVANCED", emoji: "üõ°Ô∏è" };
                if (score >= 600) return { title: "INTERMEDIATE", emoji: "üìò" };
                return { title: "NOVICE", emoji: "üå±" };
            }

            function formatTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }

            // ---------- MOCK LEADERBOARD ----------
            const mockLeaderboard = [
                { name: "LIAM", score: 1420, time: "1:24", accuracy: 98, rank: 1 },
                { name: "ELENA", score: 1380, time: "1:28", accuracy: 99, rank: 2 },
                { name: "NOAH", score: 1350, time: "1:31", accuracy: 97, rank: 3 },
                { name: "SOFIA", score: 1310, time: "1:35", accuracy: 98, rank: 4 },
                { name: "OLIVER", score: 1280, time: "1:38", accuracy: 96, rank: 5 },
                { name: "MIA", score: 1240, time: "1:42", accuracy: 97, rank: 6 },
                { name: "LUCAS", score: 1210, time: "1:45", accuracy: 95, rank: 7 },
                { name: "AMELIA", score: 1180, time: "1:48", accuracy: 96, rank: 8 },
                { name: "ELIJAH", score: 1150, time: "1:51", accuracy: 94, rank: 9 },
                { name: "HARPER", score: 1120, time: "1:54", accuracy: 95, rank: 10 }
            ];

            // ---------- POPUP FUNCTIONS ----------
            function showWordCard(wordData) {
                wordCardQueue.push(wordData);
                processWordCardQueue();
            }

            function processWordCardQueue() {
                if (showingWordCard || wordCardQueue.length === 0) return;
                
                showingWordCard = true;
                const wordData = wordCardQueue.shift();
                
                const overlay = document.getElementById('popupOverlay');
                overlay.innerHTML = '';
                
                const card = document.createElement('div');
                card.className = 'word-card';
                card.innerHTML = `
                    <div class="word-emoji">${wordData.emoji}</div>
                    <div class="word-title">${wordData.word.toUpperCase()}</div>
                    <div class="word-sentence">${wordData.sentence}</div>
                    <button class="collect-btn" id="collectWordBtn">‚ú® COLLECT</button>
                `;
                
                overlay.appendChild(card);
                overlay.classList.remove('hidden');
                
                document.getElementById('collectWordBtn').addEventListener('click', () => {
                    overlay.classList.add('hidden');
                    showingWordCard = false;
                    
                    // Check if unit completed
                    const unit = worlds[currentWorld].units.find(u => u.id === currentUnit);
                    if (unit && unit.wordsCompleted === unit.totalWords) {
                        // Unlock next unit
                        const nextUnit = worlds[currentWorld].units.find(u => u.id === currentUnit + 1);
                        if (nextUnit) {
                            nextUnit.unlocked = true;
                        }
                        
                        // Check if world completed
                        const allUnitsCompleted = worlds[currentWorld].units.every(u => u.wordsCompleted === 20);
                        if (allUnitsCompleted && currentWorld < 6) {
                            worlds[currentWorld + 1].unlocked = true;
                            // Show world unlock message
                            setTimeout(() => {
                                showWorldUnlockPopup(currentWorld + 1);
                            }, 300);
                        }
                    }
                    
                    updateWorldDisplay();
                    processWordCardQueue();
                });
                
                tg?.HapticFeedback?.notificationOccurred?.('success');
            }

            function showWorldUnlockPopup(worldId) {
                const world = worlds[worldId];
                const overlay = document.getElementById('popupOverlay');
                
                const card = document.createElement('div');
                card.className = 'artifact-card';
                card.innerHTML = `
                    <div class="artifact-emoji">${world.icon}</div>
                    <div class="artifact-title">NEW WORLD</div>
                    <div class="artifact-title">UNLOCKED!</div>
                    <div class="artifact-sub">${world.name}</div>
                    <div class="artifact-tap">‚ú® tap to continue ‚ú®</div>
                `;
                
                overlay.innerHTML = '';
                overlay.appendChild(card);
                overlay.classList.remove('hidden');
                
                card.addEventListener('click', () => {
                    overlay.classList.add('hidden');
                });
            }

            function showArtifactPopup() {
                const overlay = document.getElementById('popupOverlay');
                overlay.innerHTML = '';
                
                const artifactCard = document.createElement('div');
                artifactCard.className = 'artifact-card';
                artifactCard.innerHTML = `
                    <div class="artifact-emoji">üîÆ</div>
                    <div class="artifact-title">ARTIFACT</div>
                    <div class="artifact-title">UNLOCKED!</div>
                    <div class="artifact-sub">WORD CRYSTAL</div>
                    <div class="artifact-tap">‚ú® tap anywhere to continue ‚ú®</div>
                `;
                
                overlay.appendChild(artifactCard);
                overlay.classList.remove('hidden');
                
                artifactCard.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showLeaderboardPopup();
                });
                
                tg?.HapticFeedback?.notificationOccurred?.('success');
            }

            function showLeaderboardPopup() {
                const overlay = document.getElementById('popupOverlay');
                
                const timeElapsed = gameStartTime ? Math.floor((Date.now() - gameStartTime) / 1000) : 0;
                const accuracy = totalTaps === 0 ? 100 : Math.round((correctTaps / totalTaps) * 100);
                const playerSFR = calculateSFR(timeElapsed, accuracy, totalTaps, correctTaps);
                const playerRating = getRatingFromScore(playerSFR);
                
                const leaderboardWithPlayer = [...mockLeaderboard];
                const yourEntry = {
                    name: "YOU",
                    score: playerSFR,
                    time: formatTime(timeElapsed),
                    accuracy: accuracy,
                    rank: 0
                };
                
                leaderboardWithPlayer.push(yourEntry);
                leaderboardWithPlayer.sort((a, b) => b.score - a.score);
                leaderboardWithPlayer.forEach((entry, index) => {
                    entry.rank = index + 1;
                });
                
                let leaderboardHtml = '';
                leaderboardWithPlayer.forEach(entry => {
                    const youClass = entry.name === 'YOU' ? ' you' : '';
                    const rating = entry.name === 'YOU' ? playerRating : getRatingFromScore(entry.score);
                    
                    let crownEmoji = '';
                    if (entry.rank === 1) crownEmoji = 'üëë';
                    else if (entry.rank === 2) crownEmoji = '‚ö°';
                    else if (entry.rank === 3) crownEmoji = 'ü•â';
                    
                    leaderboardHtml += `
                        <div class="leaderboard-row${youClass}">
                            <span class="rank">${entry.rank}.</span>
                            <span class="player-name">${entry.name}</span>
                            <span class="score">${entry.score}</span>
                            <span class="rating-badge">${rating.emoji} ${rating.title}</span>
                            <span class="crown">${crownEmoji}</span>
                        </div>
                    `;
                });

                const yourRank = leaderboardWithPlayer.find(e => e.name === 'YOU').rank;
                
                const leaderboardCard = document.createElement('div');
                leaderboardCard.className = 'leaderboard-card';
                leaderboardCard.innerHTML = `
                    <div class="leaderboard-title">‚öíÔ∏è ${worlds[currentWorld].name} COMPLETE</div>
                    
                    <div class="score-highlight">
                        <div class="score-title">SPELLFORGE RATING (SFR)</div>
                        <div class="score-number">${playerSFR}</div>
                        <div class="score-rating">${playerRating.emoji} ${playerRating.title}</div>
                    </div>
                    
                    <div class="stats-row">
                        <div class="stat-item">
                            <div class="stat-value">${formatTime(timeElapsed)}</div>
                            <div class="stat-label">TIME</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${accuracy}%</div>
                            <div class="stat-label">ACCURACY</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${correctTaps}/${totalTaps}</div>
                            <div class="stat-label">TAPS</div>
                        </div>
                    </div>

                    <div class="leaderboard-title">üèÜ SFR LEADERBOARD ¬∑ ${leaderboardWithPlayer.length} PLAYERS</div>
                    <div class="leaderboard-list" id="leaderboardList">
                        ${leaderboardHtml}
                    </div>

                    <div class="leaderboard-footer">
                        You're #${yourRank} of ${leaderboardWithPlayer.length}!
                        ${yourRank === 1 ? ' üèÜ CHAMPION!' : yourRank <= 3 ? ' ‚ö° PODIUM FINISH!' : ''}
                    </div>

                    <div class="button-group">
                        <button class="action-btn" id="playAgainBtn">‚öíÔ∏è FORGE AGAIN</button>
                        <button class="action-btn secondary" id="shareBtn">üì§ SHARE</button>
                    </div>
                `;
                
                overlay.innerHTML = '';
                overlay.appendChild(leaderboardCard);
                
                setTimeout(() => {
                    const leaderboardList = document.getElementById('leaderboardList');
                    const yourRow = leaderboardList.querySelector('.leaderboard-row.you');
                    if (yourRow) {
                        yourRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 100);
                
                document.getElementById('playAgainBtn').addEventListener('click', () => {
                    overlay.classList.add('hidden');
                    resetForNewUnit();
                });

                document.getElementById('shareBtn').addEventListener('click', () => {
                    const text = `I completed ${worlds[currentWorld].name} in Spellforge with a score of ${playerSFR} SFR (${playerRating.title})! Rank #${yourRank} of ${leaderboardWithPlayer.length}! üîÆ‚öíÔ∏è`;
                    if (tg) {
                        tg.shareToStory?.(text);
                    } else {
                        alert('Share: ' + text);
                    }
                });
            }

            // ---------- GAME MECHANICS ----------
            function handleWordCompletion(wordIndex) {
                if (!completedWords.includes(wordIndex)) {
                    completedWords.push(wordIndex);
                    
                    // Update unit progress
                    const unit = worlds[currentWorld].units.find(u => u.id === currentUnit);
                    if (unit) {
                        unit.wordsCompleted = completedWords.length;
                    }
                    
                    const wordData = wordsDatabase[wordIndex];
                    showWordCard(wordData);
                }

                activeWordIndex = null;
                currentPosition = 0;
                renderAll();
                updateWorldDisplay();
            }

            function handleLetterTap(letter, indexInGrid) {
                if (gameCompleted) return;
                
                totalTaps++;
                
                if (activeWordIndex === null) {
                    tg?.HapticFeedback?.notificationOccurred?.('warning');
                    return;
                }
                
                if (completedWords.includes(activeWordIndex)) {
                    activeWordIndex = null;
                    currentPosition = 0;
                    renderAll();
                    return;
                }

                const words = getCurrentUnitWords();
                const targetWord = words[activeWordIndex].word;
                const neededLetter = targetWord[currentPosition];

                if (letter.toLowerCase() !== neededLetter.toLowerCase()) {
                    tg?.HapticFeedback?.notificationOccurred?.('error');
                    renderAll();
                    return;
                }

                correctTaps++;
                currentLetters.splice(indexInGrid, 1);
                currentPosition++;
                
                tg?.HapticFeedback?.impactOccurred?.('light');
                renderAll();

                if (currentPosition === targetWord.length) {
                    handleWordCompletion(activeWordIndex);
                }
            }

            // ---------- RENDER UI ----------
            function renderAll() {
                const words = getCurrentUnitWords();
                
                // Word list with original words
                const wordContainer = document.getElementById('wordListContainer');
                if (wordContainer) {
                    wordContainer.innerHTML = '';
                    words.forEach((w, idx) => {
                        const chip = document.createElement('div');
                        chip.className = 'word-chip';
                        if (completedWords.includes(idx)) {
                            chip.classList.add('completed');
                        } else if (activeWordIndex === idx) {
                            chip.classList.add('active-word');
                        }
                        chip.innerText = w.word;
                        chip.addEventListener('click', (e) => {
                            e.stopPropagation();
                            if (completedWords.includes(idx) || gameCompleted) return;
                            activeWordIndex = idx;
                            currentPosition = 0;
                            renderAll();
                            tg?.HapticFeedback?.selectionChanged?.();
                        });
                        wordContainer.appendChild(chip);
                    });
                }

                // Active hint
                if (activeWordIndex !== null && !completedWords.includes(activeWordIndex) && !gameCompleted) {
                    const w = words[activeWordIndex].word;
                    const progressWord = w.split('').map((l, i) => i < currentPosition ? l.toUpperCase() : '_').join(' ');
                    document.getElementById('activeWordDisplay').innerText = progressWord || '‚Äî';
                    const nextChar = (currentPosition < w.length) ? w[currentPosition].toUpperCase() : '‚úÖ';
                    document.getElementById('nextLetterDisplay').innerText = nextChar;
                } else {
                    document.getElementById('activeWordDisplay').innerText = '‚Äî';
                    document.getElementById('nextLetterDisplay').innerText = '?';
                }

                // Letter grid
                const gridContainer = document.getElementById('letterGridContainer');
                gridContainer.innerHTML = '';
                currentLetters.forEach((letter, idx) => {
                    const tile = document.createElement('div');
                    tile.className = 'letter-tile';
                    tile.innerText = letter.toUpperCase();
                    tile.addEventListener('click', (e) => {
                        e.preventDefault();
                        handleLetterTap(letter, idx);
                    });
                    gridContainer.appendChild(tile);
                });

                // Artifact text
                const artifactEl = document.getElementById('artifactText');
                const unit = worlds[currentWorld].units.find(u => u.id === currentUnit);
                if (unit) {
                    if (unit.wordsCompleted === 20) {
                        artifactEl.innerText = 'üåü UNIT COMPLETE! üåü';
                    } else {
                        artifactEl.innerText = `üîí ${unit.wordsCompleted}/20`;
                    }
                }
            }

            // ---------- RESET ----------
            function confirmReset() {
                if (tg) {
                    tg.showConfirm('Restart this ingot? All progress will be lost.', (ok) => {
                        if (ok) {
                            resetForNewUnit();
                            tg.HapticFeedback?.impactOccurred?.('heavy');
                        }
                    });
                } else {
                    if (confirm('Restart this ingot?')) {
                        resetForNewUnit();
                    }
                }
            }

            // ---------- INITIALIZATION ----------
            document.getElementById('resetButton').addEventListener('click', confirmReset);
            document.getElementById('unitSelector').addEventListener('change', (e) => {
                currentUnit = parseInt(e.target.value);
                resetForNewUnit();
                updateWorldDisplay();
            });

            // Start game
            updateWorldDisplay();
            resetForNewUnit();

            // Telegram back button
            if (tg) {
                tg.onEvent('backButtonClicked', () => {
                    tg.close();
                });
                tg.BackButton?.show();
                tg.ready();
            }
        })();
    </script>
</body>
</html>
