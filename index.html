<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spellforge ¬∑ Telegram Mini App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, system-ui, -apple-system, sans-serif;
        }

        body {
            background: linear-gradient(145deg, #1a2f3f 0%, #1e3a4a 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 12px;
            margin: 0;
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(145deg, #1a2f3f, #0f1f29);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            transition: opacity 0.5s ease;
        }

        .loading-screen.fade-out {
            opacity: 0;
            pointer-events: none;
        }

        .loading-content {
            max-width: 400px;
            width: 90%;
            text-align: center;
            padding: 20px;
        }

        .loading-image {
            width: 100%;
            max-width: 300px;
            height: auto;
            border-radius: 30px;
            margin-bottom: 25px;
            box-shadow: 0 20px 30px rgba(0,0,0,0.5);
            border: 3px solid #c9ae5b;
            animation: glowPulse 2s infinite alternate;
        }

        .loading-title {
            font-size: 36px;
            font-weight: 800;
            color: #ffdfa0;
            margin-bottom: 30px;
            letter-spacing: 2px;
            text-shadow: 3px 3px 0 #7a4c1d;
        }

        .loading-bar-container {
            width: 100%;
            height: 20px;
            background: #0c202b;
            border-radius: 30px;
            border: 2px solid #aa873f;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .loading-bar {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, #f0b345, #ffd966);
            border-radius: 30px;
            transition: width 0.3s ease;
            box-shadow: 0 0 10px #ffaa33;
        }

        .loading-text {
            font-size: 18px;
            color: #ffdcaa;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .loading-tip {
            font-size: 16px;
            color: #acccdd;
            font-style: italic;
            padding: 15px;
            background: rgba(0,0,0,0.3);
            border-radius: 30px;
            border-left: 4px solid #c9ae5b;
        }

        .game-container {
            max-width: 550px;
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 42px;
            padding: 24px 20px 30px;
            box-shadow: 0 25px 40px -10px rgba(0, 0, 0, 0.5);
            transition: all 0.2s;
        }

        /* header with world info */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            color: white;
            padding: 0 5px;
        }

        .world-info {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(0,0,0,0.3);
            padding: 8px 16px;
            border-radius: 60px;
            border: 1px solid rgba(255,215,140,0.3);
        }

        .world-icon {
            font-size: 24px;
        }

        .world-name {
            font-weight: 700;
            font-size: 18px;
            color: #ffefc0;
        }

        .title {
            font-weight: 700;
            font-size: 26px;
            letter-spacing: 1px;
            background: linear-gradient(135deg, #ffe99c, #ffd78c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        .progress-badge {
            background: rgba(255, 215, 140, 0.25);
            border: 1px solid rgba(255, 235, 150, 0.6);
            border-radius: 60px;
            padding: 8px 16px;
            font-weight: 600;
            font-size: 18px;
            color: #ffefc0;
            backdrop-filter: blur(4px);
        }

        /* word list area */
        .word-section {
            background: rgba(10, 25, 35, 0.7);
            border-radius: 38px;
            padding: 18px 15px;
            margin-bottom: 22px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.4);
        }

        .section-label {
            color: #b6d8e6;
            font-size: 15px;
            font-weight: 500;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            padding-left: 8px;
        }

        .word-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            max-height: 200px;
            overflow-y: auto;
            padding: 5px;
            scrollbar-width: thin;
            scrollbar-color: #c9ae5b #1d3f4f;
        }

        .word-grid::-webkit-scrollbar {
            width: 6px;
        }

        .word-grid::-webkit-scrollbar-track {
            background: #1d3f4f;
            border-radius: 10px;
        }

        .word-grid::-webkit-scrollbar-thumb {
            background: #c9ae5b;
            border-radius: 10px;
        }

        .word-chip {
            background: #2c4556;
            border-radius: 40px;
            padding: 12px 22px;
            font-weight: 600;
            font-size: 18px;
            color: #c9e9ff;
            box-shadow: 0 6px 0 #0f1f29, 0 8px 10px rgba(0,0,0,0.3);
            transition: all 0.1s ease;
            border: 1px solid #598baa;
            user-select: none;
            cursor: pointer;
            min-width: 90px;
            text-align: center;
        }

        .word-chip.completed {
            background: #3f6a4a;
            color: #d9ffd9;
            border-color: #a5d6a5;
            box-shadow: 0 4px 0 #1b3b24, 0 6px 8px rgba(0,0,0,0.3);
            text-decoration: line-through 2px rgba(255,255,255,0.4);
            opacity: 0.8;
            cursor: default;
            pointer-events: none;
        }

        .word-chip.active-word {
            background: #f5c542;
            color: #1e2f3a;
            border-color: #ffea9e;
            box-shadow: 0 0 0 3px #fce49c, 0 6px 0 #a07d2b;
            transform: scale(1.02);
            font-weight: 800;
        }

        /* unit selector */
        .unit-section {
            background: rgba(10, 25, 35, 0.7);
            border-radius: 38px;
            padding: 18px 15px;
            margin-bottom: 22px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.4);
        }

        .unit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 0 8px;
        }

        .unit-label {
            color: #b6d8e6;
            font-size: 15px;
            font-weight: 500;
            letter-spacing: 0.5px;
        }

        .unit-selector {
            background: #1d3f4f;
            border: 2px solid #b8944a;
            border-radius: 40px;
            padding: 8px 16px;
            color: #ffdb8e;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            outline: none;
        }

        .unit-selector option {
            background: #1d3f4f;
            color: white;
        }

        .unit-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            max-height: 200px;
            overflow-y: auto;
            padding: 5px;
            scrollbar-width: thin;
            scrollbar-color: #c9ae5b #1d3f4f;
        }

        .unit-grid::-webkit-scrollbar {
            width: 6px;
        }

        .unit-grid::-webkit-scrollbar-track {
            background: #1d3f4f;
            border-radius: 10px;
        }

        .unit-grid::-webkit-scrollbar-thumb {
            background: #c9ae5b;
            border-radius: 10px;
        }

        .unit-card {
            background: #2c4556;
            border-radius: 30px;
            padding: 12px 15px;
            min-width: 140px;
            flex: 1 0 auto;
            max-width: 160px;
            border: 2px solid #598baa;
            box-shadow: 0 4px 0 #0f1f29;
            cursor: pointer;
            transition: all 0.1s;
        }

        .unit-card.active-unit {
            background: #f5c542;
            border-color: #ffea9e;
            box-shadow: 0 0 0 3px #fce49c, 0 4px 0 #a07d2b;
        }

        .unit-card.completed {
            background: #3f6a4a;
            border-color: #a5d6a5;
            opacity: 0.8;
        }

        .unit-number {
            font-size: 14px;
            color: #acccdd;
            margin-bottom: 4px;
        }

        .unit-name {
            font-weight: 700;
            font-size: 18px;
            color: white;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .active-unit .unit-name {
            color: #1e2f3a;
        }

        .unit-progress {
            font-size: 14px;
            color: #ffdb8e;
        }

        .unit-progress-bar {
            width: 100%;
            height: 6px;
            background: #0f1f29;
            border-radius: 10px;
            margin-top: 8px;
            overflow: hidden;
        }

        .unit-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #f0b345, #ffd966);
            border-radius: 10px;
            transition: width 0.3s;
        }

        /* active word hint */
        .active-hint {
            background: #244454;
            border-radius: 30px;
            padding: 15px 18px;
            margin: 18px 0 10px;
            text-align: center;
            border-left: 8px solid #f5c542;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .target-word {
            font-size: 26px;
            font-weight: 700;
            letter-spacing: 6px;
            color: #ffea9a;
        }

        .next-letter {
            background: #f5c542;
            color: #1f2e3a;
            padding: 8px 25px;
            border-radius: 50px;
            font-weight: 700;
            font-size: 24px;
            min-width: 70px;
            text-align: center;
            box-shadow: 0 4px 0 #946f2c;
        }

        /* letter bank */
        .letter-section {
            background: rgba(10, 25, 35, 0.7);
            border-radius: 38px;
            padding: 18px 12px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .letter-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
        }

        .letter-tile {
            width: 62px;
            height: 62px;
            background: linear-gradient(145deg, #ffcf8a, #febf6e);
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 34px;
            color: #1f3b4a;
            box-shadow: 0 9px 0 #b2752e, 0 10px 18px rgba(0, 0, 0, 0.4);
            transition: all 0.08s linear;
            cursor: pointer;
            border: 2px solid #ffdcaa;
            text-transform: uppercase;
            user-select: none;
        }

        .letter-tile:active {
            transform: translateY(6px);
            box-shadow: 0 3px 0 #b2752e, 0 8px 12px rgba(0,0,0,0.4);
        }

        .letter-tile.used {
            background: #3a4d5e;
            box-shadow: 0 4px 0 #1d2c36, 0 6px 8px rgba(0,0,0,0.3);
            border-color: #5b7485;
            color: #a1b9cc;
            cursor: not-allowed;
            transform: translateY(5px);
            pointer-events: none;
            opacity: 0.5;
        }

        /* reset button */
        .reset-btn {
            background: #334e62;
            border: none;
            border-radius: 60px;
            padding: 18px 25px;
            font-weight: 700;
            font-size: 20px;
            color: #ffefcf;
            box-shadow: 0 8px 0 #1c2f3b, 0 6px 15px black;
            cursor: pointer;
            width: 100%;
            transition: 0.08s;
            border: 1px solid #63879e;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .reset-btn:active {
            transform: translateY(5px);
            box-shadow: 0 3px 0 #1c2f3b, 0 6px 10px black;
        }

        /* popup overlay base */
        .popup-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: all 0.3s;
            padding: 16px;
            box-sizing: border-box;
            overflow-y: auto;
        }

        /* word card - with smaller collect button */
        .word-card {
            max-width: 380px;
            width: 100%;
            background: linear-gradient(165deg, #fff8e7, #ffffff);
            border-radius: 58px;
            padding: 30px 20px;
            box-shadow: 0 30px 50px #00000080, 0 0 0 6px #fad87c;
            text-align: center;
            animation: pop 0.3s cubic-bezier(0.2, 0.9, 0.3, 1.3);
            border: 3px solid #ffcd7e;
            margin: auto;
        }

        @keyframes pop {
            0% { transform: scale(0.7); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .word-emoji {
            font-size: 110px;
            line-height: 1.2;
            margin: 5px 0;
        }

        .word-title {
            font-size: 58px;
            font-weight: 900;
            color: #1f4a5c;
            text-transform: uppercase;
            letter-spacing: 3px;
            text-shadow: 3px 5px 0 #ffcd7e;
            margin: 5px 0;
            word-break: break-word;
        }

        .word-sentence {
            font-size: 22px;
            background: #ebcba0;
            padding: 20px;
            border-radius: 40px;
            color: #1f3a47;
            font-weight: 500;
            margin: 20px 0;
            border: 2px dashed #a5723b;
            word-break: break-word;
        }

        /* 25% smaller collect button */
        .collect-btn {
            background: #f5b342;
            border: none;
            border-radius: 50px;
            padding: 14px;
            font-weight: 700;
            font-size: 22px;
            color: #1f3826;
            box-shadow: 0 5px 0 #9e691f;
            cursor: pointer;
            width: 80%;
            margin: 0 auto;
            display: block;
            border: 2px solid #ffe39b;
            transition: 0.08s;
        }

        .collect-btn:active {
            transform: translateY(3px);
            box-shadow: 0 2px 0 #9e691f;
        }

        /* ingot complete popup */
        .ingot-card {
            max-width: 420px;
            width: 100%;
            background: linear-gradient(165deg, #4a2e1e, #6b4a2e);
            border-radius: 70px;
            padding: 40px 25px 45px;
            box-shadow: 0 30px 50px #000000cc, 0 0 0 8px #ffd966;
            text-align: center;
            animation: glowPulse 2s infinite alternate;
            border: 3px solid #ffb347;
            margin: auto;
        }

        @keyframes glowPulse {
            from { box-shadow: 0 30px 50px #000000cc, 0 0 0 8px #ffd966; }
            to { box-shadow: 0 30px 60px #000000, 0 0 0 12px #ffaa33; }
        }

        .ingot-emoji {
            font-size: 90px;
            line-height: 1.2;
            margin: 15px 0;
            filter: drop-shadow(8px 15px 0 #3f2b16);
        }

        .ingot-title {
            font-size: 48px;
            font-weight: 900;
            color: #ffecb3;
            text-transform: uppercase;
            letter-spacing: 4px;
            text-shadow: 5px 5px 0 #7a4c1d;
            margin: 5px 0;
            line-height: 1.2;
        }

        .ingot-sub {
            font-size: 28px;
            color: #ffe39a;
            background: #3d2b17;
            padding: 12px 20px;
            border-radius: 60px;
            margin: 20px 0 15px;
            border: 2px solid #e5a449;
        }

        .ingot-stats {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
        }

        .ingot-stat {
            text-align: center;
        }

        .ingot-stat-value {
            font-size: 32px;
            font-weight: 800;
            color: #ffdb8e;
        }

        .ingot-stat-label {
            font-size: 14px;
            color: #acccdd;
        }

        .ingot-buttons {
            display: flex;
            gap: 12px;
            margin-top: 25px;
        }

        .ingot-btn {
            flex: 1;
            background: #f0b345;
            border: none;
            border-radius: 40px;
            padding: 16px 10px;
            font-weight: 700;
            font-size: 20px;
            color: #1d332b;
            box-shadow: 0 5px 0 #9e691f;
            cursor: pointer;
            border: 2px solid #ffe694;
            transition: 0.08s;
        }

        .ingot-btn:active {
            transform: translateY(4px);
            box-shadow: 0 1px 0 #9e691f;
        }

        .ingot-btn.secondary {
            background: #557a8b;
            box-shadow: 0 5px 0 #2e4a57;
            color: white;
        }

        /* simplified next ingot preview popup */
        .preview-card {
            max-width: 440px;
            width: 100%;
            background: linear-gradient(165deg, #1e3b4a, #16323f);
            border-radius: 60px;
            padding: 30px 25px;
            box-shadow: 0 30px 50px #000000cc, 0 0 0 8px #c9ae5b;
            text-align: center;
            border: 3px solid #dbb45c;
            margin: auto;
        }

        .preview-title {
            font-size: 32px;
            font-weight: 800;
            color: #ffdfa0;
            margin-bottom: 15px;
        }

        .preview-ingot {
            font-size: 28px;
            font-weight: 700;
            color: #ffdb8e;
            margin-bottom: 20px;
        }

        .chance-container {
            background: #0e2938;
            border-radius: 50px;
            padding: 20px;
            margin: 20px 0;
            border: 2px solid #b8944a;
        }

        .chance-label {
            font-size: 18px;
            color: #acccdd;
            margin-bottom: 10px;
        }

        .chance-value {
            font-size: 72px;
            font-weight: 900;
            line-height: 1;
            margin-bottom: 15px;
        }

        .chance-high { color: #4ade80; }
        .chance-medium { color: #fbbf24; }
        .chance-low { color: #f87171; }

        .chance-bar {
            width: 100%;
            height: 20px;
            background: #0f1f29;
            border-radius: 30px;
            overflow: hidden;
            margin: 15px 0;
        }

        .chance-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #f0b345, #ffd966);
            border-radius: 30px;
            transition: width 0.3s;
        }

        .preview-buttons {
            display: flex;
            gap: 12px;
            margin-top: 25px;
        }

        .preview-btn {
            flex: 1;
            background: #f0b345;
            border: none;
            border-radius: 40px;
            padding: 16px 10px;
            font-weight: 700;
            font-size: 20px;
            color: #1d332b;
            box-shadow: 0 5px 0 #9e691f;
            cursor: pointer;
            border: 2px solid #ffe694;
            transition: 0.08s;
        }

        .preview-btn:active {
            transform: translateY(4px);
            box-shadow: 0 1px 0 #9e691f;
        }

        .preview-btn.secondary {
            background: #557a8b;
            box-shadow: 0 5px 0 #2e4a57;
            color: white;
        }

        /* practice mode popup */
        .practice-card {
            max-width: 440px;
            width: 100%;
            background: linear-gradient(165deg, #1e3b4a, #16323f);
            border-radius: 60px;
            padding: 30px 25px;
            box-shadow: 0 30px 50px #000000cc, 0 0 0 8px #c9ae5b;
            text-align: center;
            border: 3px solid #dbb45c;
            margin: auto;
            max-height: 80vh;
            overflow-y: auto;
        }

        .practice-title {
            font-size: 32px;
            font-weight: 800;
            color: #ffdfa0;
            margin-bottom: 20px;
        }

        .practice-list {
            background: #0c202b;
            border-radius: 40px;
            padding: 15px;
            margin: 15px 0;
            border: 2px solid #aa873f;
        }

        .practice-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            margin: 5px 0;
            background: #1d3f4f;
            border-radius: 40px;
            cursor: pointer;
            transition: all 0.1s;
        }

        .practice-item:hover {
            background: #2c5a6e;
        }

        .practice-item.selected {
            background: #c9a34b;
            color: #0a1f29;
            border: 2px solid gold;
        }

        .practice-item-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .practice-icon {
            font-size: 24px;
        }

        .practice-name {
            font-weight: 600;
            font-size: 18px;
        }

        .practice-chance {
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 30px;
            background: rgba(0,0,0,0.3);
        }

        /* world complete popup */
        .world-card {
            max-width: 420px;
            width: 100%;
            background: linear-gradient(165deg, #1e3b4a, #16323f);
            border-radius: 70px;
            padding: 40px 25px 45px;
            box-shadow: 0 30px 50px #000000cc, 0 0 0 8px #c9ae5b;
            text-align: center;
            animation: glowPulse 2s infinite alternate;
            border: 3px solid #dbb45c;
            margin: auto;
        }

        .world-emoji {
            font-size: 90px;
            line-height: 1.2;
            margin: 15px 0;
        }

        .world-title {
            font-size: 48px;
            font-weight: 900;
            color: #ffdfa0;
            text-transform: uppercase;
            letter-spacing: 4px;
            text-shadow: 5px 5px 0 #4a2e1e;
            margin: 5px 0;
        }

        .world-sub {
            font-size: 28px;
            color: #ffdcaa;
            background: #0e2938;
            padding: 12px 20px;
            border-radius: 60px;
            margin: 20px 0;
            border: 2px solid #b8944a;
        }

        /* artifact popup */
        .artifact-card {
            max-width: 420px;
            width: 100%;
            background: linear-gradient(165deg, #4a2e1e, #6b4a2e);
            border-radius: 70px;
            padding: 40px 25px 45px;
            box-shadow: 0 30px 50px #000000cc, 0 0 0 8px #ffd966;
            text-align: center;
            animation: glowPulse 2s infinite alternate;
            border: 3px solid #ffb347;
            margin: auto;
        }

        .artifact-emoji {
            font-size: 120px;
            line-height: 1.2;
            margin: 15px 0;
            filter: drop-shadow(8px 15px 0 #3f2b16);
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
            100% { transform: translateY(0px); }
        }

        .artifact-title {
            font-size: 58px;
            font-weight: 900;
            color: #ffecb3;
            text-transform: uppercase;
            letter-spacing: 4px;
            text-shadow: 5px 5px 0 #7a4c1d;
            margin: 10px 0;
            line-height: 1.2;
        }

        .artifact-sub {
            font-size: 24px;
            color: #ffe39a;
            background: #3d2b17;
            padding: 15px 20px;
            border-radius: 60px;
            margin: 25px 0 15px;
            border: 2px solid #e5a449;
        }

        .artifact-tap {
            font-size: 20px;
            color: #ffdb9f;
            margin-top: 30px;
            opacity: 0.9;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }

        /* leaderboard popup - scrollable */
        .leaderboard-card {
            max-width: 480px;
            width: 100%;
            max-height: 90vh;
            background: linear-gradient(165deg, #1e3b4a, #16323f);
            border-radius: 50px;
            padding: 20px 18px 22px;
            box-shadow: 0 25px 45px #000000, 0 0 0 6px #c9ae5b;
            text-align: center;
            border: 2px solid #dbb45c;
            animation: pop 0.3s ease-out;
            margin: auto;
            display: flex;
            flex-direction: column;
        }

        .stats-row {
            display: flex;
            justify-content: space-around;
            background: #0e2938;
            border-radius: 40px;
            padding: 12px 10px;
            margin: 10px 0 15px;
            border: 2px solid #b8944a;
            flex-shrink: 0;
        }

        .stat-item {
            text-align: center;
            color: white;
            min-width: 70px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 800;
            color: #ffdb8e;
            line-height: 1.2;
        }

        .stat-label {
            font-size: 13px;
            color: #acccdd;
            text-transform: uppercase;
        }

        .score-highlight {
            background: #f5b342;
            border-radius: 60px;
            padding: 15px;
            margin: 5px 0 10px;
            border: 3px solid gold;
            box-shadow: 0 0 20px gold;
            flex-shrink: 0;
        }

        .score-title {
            font-size: 16px;
            color: #1e3a4a;
            font-weight: 600;
            letter-spacing: 1px;
        }

        .score-number {
            font-size: 52px;
            font-weight: 900;
            color: #1f2e3a;
            line-height: 1.1;
            text-shadow: 2px 2px 0 #ffdb8e;
        }

        .score-rating {
            font-size: 24px;
            font-weight: 800;
            color: #1f2e3a;
        }

        .leaderboard-title {
            font-size: 24px;
            font-weight: 800;
            color: #ffdfa0;
            margin: 5px 0 10px;
            letter-spacing: 1px;
            flex-shrink: 0;
        }

        /* Scrollable leaderboard list */
        .leaderboard-list {
            background: #0c202b;
            border-radius: 30px;
            padding: 12px;
            margin: 5px 0 10px;
            border: 2px solid #aa873f;
            overflow-y: auto;
            flex-grow: 1;
            min-height: 200px;
            max-height: 350px;
            scrollbar-width: thin;
            scrollbar-color: #c9ae5b #1d3f4f;
        }

        .leaderboard-list::-webkit-scrollbar {
            width: 6px;
        }

        .leaderboard-list::-webkit-scrollbar-track {
            background: #1d3f4f;
            border-radius: 10px;
        }

        .leaderboard-list::-webkit-scrollbar-thumb {
            background: #c9ae5b;
            border-radius: 10px;
        }

        .leaderboard-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 15px;
            margin: 4px 0;
            background: #1d3f4f;
            border-radius: 40px;
            font-size: 16px;
            font-weight: 600;
            color: white;
            transition: all 0.1s;
        }

        .leaderboard-row.you {
            background: #c9a34b;
            color: #0a1f29;
            font-weight: 800;
            border: 2px solid gold;
            box-shadow: 0 0 15px gold;
            transform: scale(1.02);
        }

        .rank {
            min-width: 35px;
            font-size: 15px;
        }

        .player-name {
            flex: 1;
            text-align: left;
            padding-left: 8px;
            font-size: 15px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 130px;
        }

        .score {
            font-weight: 700;
            color: #ffd966;
            font-size: 15px;
            min-width: 55px;
            text-align: right;
        }

        .you .score {
            color: #2d1905;
        }

        .rating-badge {
            font-size: 14px;
            margin-left: 6px;
            min-width: 55px;
            text-align: right;
            padding: 3px 6px;
            border-radius: 20px;
            background: rgba(0,0,0,0.3);
        }

        .you .rating-badge {
            background: rgba(255,215,0,0.3);
        }

        .leaderboard-footer {
            font-size: 16px;
            color: #ffdcaa;
            margin: 10px 0 8px;
            font-weight: 500;
            flex-shrink: 0;
        }

        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 12px;
            flex-shrink: 0;
        }

        .action-btn {
            flex: 1;
            background: #f0b345;
            border: none;
            border-radius: 40px;
            padding: 14px 10px;
            font-weight: 700;
            font-size: 20px;
            color: #1d332b;
            box-shadow: 0 5px 0 #9e691f;
            cursor: pointer;
            border: 2px solid #ffe694;
            transition: 0.08s;
        }

        .action-btn:active {
            transform: translateY(4px);
            box-shadow: 0 1px 0 #9e691f;
        }

        .action-btn.secondary {
            background: #557a8b;
            box-shadow: 0 5px 0 #2e4a57;
            color: white;
        }

        .hidden {
            display: none !important;
        }

        /* artifact area */
        .artifact-box {
            background: #1d3643;
            border-radius: 32px;
            margin: 15px 0 10px;
            padding: 14px 20px;
            color: #ffeec2;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 24px;
            font-weight: 700;
            border: 2px solid #c5a15b;
        }

        .artifact-icon {
            font-size: 44px;
            filter: drop-shadow(0 4px 2px black);
        }

        .telegram-footer {
            font-size: 14px;
            text-align: center;
            color: #aac3d0;
            margin-top: 20px;
        }

        @media (max-height: 700px) {
            .leaderboard-card {
                padding: 15px 15px 18px;
            }
            .stats-row {
                padding: 8px 5px;
                margin: 5px 0 10px;
            }
            .stat-value {
                font-size: 24px;
            }
            .score-number {
                font-size: 42px;
            }
            .word-grid {
                max-height: 150px;
            }
            .unit-grid {
                max-height: 150px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-content">
            <img src="https://i.postimg.cc/TwmzR9V2/grok-image-1772302795443.jpg" 
                 alt="Spellforge" 
                 class="loading-image">
            <div class="loading-title">‚öíÔ∏è SPELLFORGE</div>
            <div class="loading-bar-container">
                <div class="loading-bar" id="loadingBar"></div>
            </div>
            <div class="loading-text" id="loadingText">Loading forge...</div>
            <div class="loading-tip" id="loadingTip">
                "Every word forged strengthens the crystal"
            </div>
        </div>
    </div>

    <div class="game-container" id="gameContainer">
        <!-- header with world info -->
        <div class="header">
            <div class="world-info" id="worldInfo">
                <span class="world-icon" id="worldIcon">‚öíÔ∏è</span>
                <span class="world-name" id="worldName">Grand Forge</span>
            </div>
            <span class="progress-badge" id="progressDisplay">0/600</span>
        </div>

        <!-- unit selector section -->
        <div class="unit-section">
            <div class="unit-header">
                <span class="unit-label" id="unitLabel">INGOTS</span>
                <select class="unit-selector" id="unitSelector">
                    <option value="1">Ingot 01 ¬∑ First Spark</option>
                </select>
            </div>
            <div class="unit-grid" id="unitGrid"></div>
        </div>

        <!-- word list area -->
        <div class="word-section">
            <div class="section-label">üìã WORDS TO FORGE ¬∑ tap any to start</div>
            <div class="word-grid" id="wordListContainer"></div>
        </div>

        <!-- active word hint -->
        <div class="active-hint" id="activeHintArea">
            <span class="target-word" id="activeWordDisplay">‚Äî</span>
            <span class="next-letter" id="nextLetterDisplay">?</span>
        </div>

        <!-- letter grid -->
        <div class="letter-section">
            <div class="section-label">üî§ LETTER FORGE ¬∑ tap in order</div>
            <div class="letter-grid" id="letterGridContainer"></div>
        </div>

        <!-- artifact progress -->
        <div class="artifact-box" id="artifactBox">
            <span class="artifact-icon">üèÜ</span>
            <span id="artifactText">üîí 0/20</span>
            <span>‚öíÔ∏è</span>
        </div>

        <!-- reset button -->
        <button class="reset-btn" id="resetButton">üîÑ FORGE AGAIN</button>
        <div class="telegram-footer">Telegram Mini App ¬∑ forge words to unlock</div>
    </div>

    <!-- popup overlay -->
    <div id="popupOverlay" class="popup-overlay hidden"></div>

    <script>
        (function() {
            // ---------- TELEGRAM INTEGRATION ----------
            let tg = window.Telegram?.WebApp;
            if (tg) {
                tg.expand();
                tg.enableClosingConfirmation?.();
                tg.setHeaderColor?.('#1a2f3f');
            }

            // ---------- LOADING SCREEN ----------
            const loadingTips = [
                '"Every word forged strengthens the crystal"',
                '"The forge remembers every letter"',
                '"Speed and accuracy forge the strongest words"',
                '"Ancient runes glow brighter with each completion"',
                '"The Word Crystal chooses its master wisely"',
                '"Patience tempers the strongest steel"',
                '"Even legends started as apprentices"',
                '"The guild watches your progress"',
                '"Each ingot tells a story"',
                '"Forgemasters never rush the craft"'
            ];

            document.getElementById('loadingTip').innerText = 
                loadingTips[Math.floor(Math.random() * loadingTips.length)];

            let loadingComplete = false;
            let minimumTimePassed = false;

            function simulateLoading() {
                const loadingScreen = document.getElementById('loadingScreen');
                const loadingBar = document.getElementById('loadingBar');
                const loadingText = document.getElementById('loadingText');
                const loadingTip = document.getElementById('loadingTip');
                
                let progress = 0;
                const interval = setInterval(() => {
                    progress += Math.random() * 15 + 5;
                    
                    if (progress >= 100) {
                        progress = 100;
                        loadingBar.style.width = progress + '%';
                        loadingText.innerText = 'Forge ready!';
                        
                        loadingComplete = true;
                        if (minimumTimePassed) {
                            setTimeout(() => {
                                loadingScreen.classList.add('fade-out');
                                setTimeout(() => {
                                    loadingScreen.style.display = 'none';
                                }, 500);
                            }, 300);
                        }
                        clearInterval(interval);
                    } else {
                        loadingBar.style.width = progress + '%';
                        loadingText.innerText = `Loading forge... ${Math.floor(progress)}%`;
                        
                        if (Math.random() > 0.7) {
                            const randomTip = loadingTips[Math.floor(Math.random() * loadingTips.length)];
                            loadingTip.innerText = randomTip;
                        }
                    }
                }, 200);
            }

            setTimeout(() => {
                minimumTimePassed = true;
                if (loadingComplete) {
                    document.getElementById('loadingScreen').classList.add('fade-out');
                    setTimeout(() => {
                        document.getElementById('loadingScreen').style.display = 'none';
                    }, 500);
                }
            }, 2000);

            window.addEventListener('load', simulateLoading);

            // ---------- MASTER WORD BANK ¬∑ 3,600 WORDS ----------
            const MASTER_WORDS = {
                // WORLD 1: GRAND FORGE (600 words)
                world1: {
                    name: "Grand Forge",
                    icon: "‚öíÔ∏è",
                    unitType: "Ingot",
                    units: {
                        1: { // Ingot 01: First Spark
                            name: "First Spark",
                            words: [
                                { word: "alien", emoji: "üëΩ", sentence: "The friendly alien played guitar with astronauts." },
                                { word: "among", emoji: "üïµÔ∏è", sentence: "A red mushroom stood among the green ferns." },
                                { word: "chart", emoji: "üìä", sentence: "We made a chart of everyone's favorite pizza." },
                                { word: "cloud", emoji: "‚òÅÔ∏è", sentence: "That cloud looks exactly like a dragon." },
                                { word: "comprehend", emoji: "üß†", sentence: "It's hard to comprehend how big the universe is." },
                                { word: "describe", emoji: "üó£Ô∏è", sentence: "Can you describe your perfect day?" },
                                { word: "ever", emoji: "üåü", sentence: "This is the most beautiful sunset ever." },
                                { word: "fail", emoji: "üò§", sentence: "It's okay to fail when you're learning something new." },
                                { word: "friendly", emoji: "üêï", sentence: "The friendly dog wagged its tail at everyone." },
                                { word: "grade", emoji: "üìù", sentence: "She got an A+ on her spelling grade." },
                                { word: "instead", emoji: "üîÑ", sentence: "Let's play outside instead of watching TV." },
                                { word: "library", emoji: "üìö", sentence: "The library has a story hour every Tuesday." },
                                { word: "planet", emoji: "ü™ê", sentence: "Which planet has the most beautiful rings?" },
                                { word: "report", emoji: "üì∞", sentence: "I need to write a report about frogs." },
                                { word: "several", emoji: "üßÆ", sentence: "I've read several books by that author." },
                                { word: "solve", emoji: "üß©", sentence: "Together we can solve any puzzle." },
                                { word: "suddenly", emoji: "‚ö°", sentence: "Suddenly, the room filled with colorful light." },
                                { word: "suppose", emoji: "ü§î", sentence: "I suppose we could share the last cookie." },
                                { word: "universe", emoji: "üåå", sentence: "How many stars are in the universe?" },
                                { word: "view", emoji: "üèûÔ∏è", sentence: "The view from the mountain was incredible." }
                            ]
                        },
                        2: { // Ingot 02: Kindling
                            name: "Kindling",
                            words: [
                                { word: "afraid", emoji: "üò®", sentence: "The mouse was afraid of the cat." },
                                { word: "agree", emoji: "ü§ù", sentence: "We all agree that pizza is delicious." },
                                { word: "angry", emoji: "üò†", sentence: "He was angry when his ice cream fell." },
                                { word: "arrive", emoji: "üö™", sentence: "We will arrive at the party soon." },
                                { word: "attack", emoji: "‚öîÔ∏è", sentence: "The knight prepared to attack." },
                                { word: "bottom", emoji: "‚¨áÔ∏è", sentence: "The treasure was at the bottom of the sea." },
                                { word: "clever", emoji: "ü¶ä", sentence: "The clever fox solved the puzzle." },
                                { word: "cruel", emoji: "üëø", sentence: "The cruel witch cast a spell." },
                                { word: "finally", emoji: "üéâ", sentence: "Finally, summer vacation arrived!" },
                                { word: "hide", emoji: "üôà", sentence: "Let's hide behind the big tree." },
                                { word: "hunt", emoji: "üèπ", sentence: "They hunt for hidden treasure." },
                                { word: "lot", emoji: "üì¶", sentence: "I have a lot of homework today." },
                                { word: "middle", emoji: "üéØ", sentence: "She sat in the middle of the row." },
                                { word: "moment", emoji: "‚è∞", sentence: "Wait a moment, I'm almost ready." },
                                { word: "pleased", emoji: "üòä", sentence: "Mother was pleased with the gift." },
                                { word: "promise", emoji: "ü§û", sentence: "I promise to share my cookies." },
                                { word: "reply", emoji: "üí¨", sentence: "Please reply to my message." },
                                { word: "safe", emoji: "üõ°Ô∏è", sentence: "We are safe inside the castle." },
                                { word: "trick", emoji: "üé©", sentence: "The magician performed a clever trick." },
                                { word: "well", emoji: "üíß", sentence: "The water from the well is cold." }
                            ]
                        },
                        3: { // Ingot 03: Ember
                            name: "Ember",
                            words: [
                                { word: "adventure", emoji: "üó∫Ô∏è", sentence: "The adventure through the forest was exciting." },
                                { word: "approach", emoji: "üö∂", sentence: "We watched the lion approach slowly." },
                                { word: "carefully", emoji: "üë£", sentence: "She carefully placed the eggs in the basket." },
                                { word: "chemical", emoji: "üß™", sentence: "The chemical turned blue when mixed." },
                                { word: "create", emoji: "üé®", sentence: "Let's create a beautiful painting." },
                                { word: "evil", emoji: "üòà", sentence: "The evil villain laughed loudly." },
                                { word: "experiment", emoji: "üî¨", sentence: "Our science experiment bubbled and fizzed." },
                                { word: "kill", emoji: "üíÄ", sentence: "The knight did not want to kill the dragon." },
                                { word: "laboratory", emoji: "ü•º", sentence: "The laboratory was full of strange equipment." },
                                { word: "laugh", emoji: "üòÇ", sentence: "The joke made everyone laugh." },
                                { word: "loud", emoji: "üîä", sentence: "The thunder was so loud it shook the house." },
                                { word: "nervous", emoji: "üò∞", sentence: "She felt nervous before her speech." },
                                { word: "noise", emoji: "üì¢", sentence: "The noise from the construction was distracting." },
                                { word: "project", emoji: "üìã", sentence: "Our school project is about volcanoes." },
                                { word: "scare", emoji: "üëª", sentence: "The loud noise might scare the cat." },
                                { word: "secret", emoji: "ü§´", sentence: "They shared a secret whispered in the dark." },
                                { word: "shout", emoji: "üì£", sentence: "Don't shout in the library." },
                                { word: "smell", emoji: "üëÉ", sentence: "I can smell fresh bread baking." },
                                { word: "terrible", emoji: "üíî", sentence: "The news was terrible and made us sad." },
                                { word: "worse", emoji: "‚¨áÔ∏è", sentence: "The storm got worse as the night went on." }
                            ]
                        },
                        4: { // Ingot 04: Bellows
                            name: "Bellows",
                            words: [
                                { word: "appropriate", emoji: "‚úÖ", sentence: "Wear appropriate clothes for cold weather." },
                                { word: "avoid", emoji: "üö´", sentence: "Try to avoid walking in puddles." },
                                { word: "behave", emoji: "üêï", sentence: "The dog learned to behave at the park." },
                                { word: "calm", emoji: "üòå", sentence: "Take deep breaths to stay calm." },
                                { word: "concern", emoji: "ü§î", sentence: "My concern is that we might be late." },
                                { word: "content", emoji: "üòä", sentence: "The cat was content in the sunny spot." },
                                { word: "expect", emoji: "üîÆ", sentence: "I expect you to finish your homework." },
                                { word: "frequently", emoji: "‚è±Ô∏è", sentence: "We frequently visit grandma on Sundays." },
                                { word: "habit", emoji: "üîÑ", sentence: "Brushing teeth is a good habit." },
                                { word: "instruct", emoji: "üìù", sentence: "The coach will instruct us on the rules." },
                                { word: "issue", emoji: "‚ö†Ô∏è", sentence: "There was an issue with the computer." },
                                { word: "none", emoji: "0Ô∏è‚É£", sentence: "None of the cookies were left." },
                                { word: "patient", emoji: "üßò", sentence: "Be patient, your turn will come." },
                                { word: "positive", emoji: "‚ûï", sentence: "Stay positive even when things are hard." },
                                { word: "punish", emoji: "‚õî", sentence: "Parents should not punish too harshly." },
                                { word: "represent", emoji: "üèõÔ∏è", sentence: "The flag represents our country." },
                                { word: "shake", emoji: "üëã", sentence: "Shake hands when you meet someone new." },
                                { word: "spread", emoji: "ü¶ã", sentence: "Butterflies spread their wings to fly." },
                                { word: "stroll", emoji: "üö∂", sentence: "Let's stroll through the park together." },
                                { word: "village", emoji: "üèòÔ∏è", sentence: "The village had one small store." }
                            ]
                        },
                        5: { name: "Tongs", words: [] },
                        6: { name: "Hammer", words: [] },
                        7: { name: "Anvil", words: [] },
                        8: { name: "Quench", words: [] },
                        9: { name: "Temper", words: [] },
                        10: { name: "Forgefire", words: [] },
                        11: { name: "Raw Iron", words: [] },
                        12: { name: "Steel Blend", words: [] },
                        13: { name: "Fold", words: [] },
                        14: { name: "Shape", words: [] },
                        15: { name: "Edge", words: [] },
                        16: { name: "Curve", words: [] },
                        17: { name: "Point", words: [] },
                        18: { name: "Balance", words: [] },
                        19: { name: "Polish", words: [] },
                        20: { name: "Gleam", words: [] },
                        21: { name: "Pattern", words: [] },
                        22: { name: "Inlay", words: [] },
                        23: { name: "Filigree", words: [] },
                        24: { name: "Engrave", words: [] },
                        25: { name: "Harden", words: [] },
                        26: { name: "Resilience", words: [] },
                        27: { name: "Legacy", words: [] },
                        28: { name: "Masterpiece", words: [] },
                        29: { name: "Legendary", words: [] },
                        30: { name: "Soulforge", words: [] }
                    }
                },
                // WORLD 2: ENCHANTED FOREST (600 words)
                world2: {
                    name: "Enchanted Forest",
                    icon: "üå≥",
                    unitType: "Seed",
                    units: {
                        31: { name: "First Rain", words: [] },
                        32: { name: "Sunlight", words: [] },
                        33: { name: "Rich Soil", words: [] },
                        34: { name: "Tiny Sprout", words: [] },
                        35: { name: "New Leaf", words: [] },
                        36: { name: "Morning Dew", words: [] },
                        37: { name: "Gentle Breeze", words: [] },
                        38: { name: "Deep Roots", words: [] },
                        39: { name: "Growing Stem", words: [] },
                        40: { name: "Forest Floor", words: [] },
                        41: { name: "Forest Flowers", words: [] },
                        42: { name: "Bee's Visit", words: [] },
                        43: { name: "Woodland Song", words: [] },
                        44: { name: "Mushroom Ring", words: [] },
                        45: { name: "Fern Unfurling", words: [] },
                        46: { name: "Mossy Stone", words: [] },
                        47: { name: "Wild Berry", words: [] },
                        48: { name: "Falling Petal", words: [] },
                        49: { name: "Forest Pool", words: [] },
                        50: { name: "Firefly Light", words: [] },
                        51: { name: "Whispering Pine", words: [] },
                        52: { name: "Oak's Strength", words: [] },
                        53: { name: "Willow's Grace", words: [] },
                        54: { name: "Hidden Glade", words: [] },
                        55: { name: "Spirit Tree", words: [] },
                        56: { name: "Autumn Gold", words: [] },
                        57: { name: "Winter Rest", words: [] },
                        58: { name: "Spring Thaw", words: [] },
                        59: { name: "Eternal Grove", words: [] },
                        60: { name: "Heartwood", words: [] }
                    }
                },
                // WORLD 3: CRYSTAL CAVERNS (600 words)
                world3: {
                    name: "Crystal Caverns",
                    icon: "üíé",
                    unitType: "Geode",
                    units: {
                        61: { name: "Hidden Treasure", words: [] },
                        62: { name: "Rough Exterior", words: [] },
                        63: { name: "First Crack", words: [] },
                        64: { name: "Glimpse Inside", words: [] },
                        65: { name: "Sparkling Facet", words: [] },
                        66: { name: "Crystal Heart", words: [] },
                        67: { name: "Underground", words: [] },
                        68: { name: "Cave Echo", words: [] },
                        69: { name: "Stalactite", words: [] },
                        70: { name: "Stalagmite", words: [] },
                        71: { name: "Amethyst Dream", words: [] },
                        72: { name: "Quartz Clarity", words: [] },
                        73: { name: "Citrine Spark", words: [] },
                        74: { name: "Geode Chamber", words: [] },
                        75: { name: "Crystal Garden", words: [] },
                        76: { name: "Underground River", words: [] },
                        77: { name: "Mineral Vein", words: [] },
                        78: { name: "Fossil Memory", words: [] },
                        79: { name: "Cave Painting", words: [] },
                        80: { name: "Bioluminescence", words: [] },
                        81: { name: "Rainbow Geode", words: [] },
                        82: { name: "Crystal Heart", words: [] },
                        83: { name: "Cave of Voices", words: [] },
                        84: { name: "Gemstone Crown", words: [] },
                        85: { name: "Underground Sea", words: [] },
                        86: { name: "Crystal Lattice", words: [] },
                        87: { name: "Light Prism", words: [] },
                        88: { name: "Geode Throne", words: [] },
                        89: { name: "Deep Earth", words: [] },
                        90: { name: "Living Crystal", words: [] }
                    }
                },
                // WORLD 4: SKY CITADEL (600 words)
                world4: {
                    name: "Sky Citadel",
                    icon: "‚òÅÔ∏è",
                    unitType: "Cloud",
                    units: {
                        91: { name: "Morning Mist", words: [] },
                        92: { name: "Gentle Breeze", words: [] },
                        93: { name: "Floating High", words: [] },
                        94: { name: "Golden Sunrise", words: [] },
                        95: { name: "Silver Lining", words: [] },
                        96: { name: "Cotton Drift", words: [] },
                        97: { name: "Sky Painting", words: [] },
                        98: { name: "First Star", words: [] },
                        99: { name: "Twilight Glow", words: [] },
                        100: { name: "Wisp", words: [] },
                        101: { name: "Cumulus Pile", words: [] },
                        102: { name: "Cirrus Whisper", words: [] },
                        103: { name: "Stratus Blanket", words: [] },
                        104: { name: "Rainbow Arch", words: [] },
                        105: { name: "Distant Thunder", words: [] },
                        106: { name: "Lightning Flash", words: [] },
                        107: { name: "Storm Cloud", words: [] },
                        108: { name: "Rain Fall", words: [] },
                        109: { name: "Rainbow's End", words: [] },
                        110: { name: "Double Rainbow", words: [] },
                        111: { name: "Thunderhead", words: [] },
                        112: { name: "Eye of Storm", words: [] },
                        113: { name: "Sky Castle", words: [] },
                        114: { name: "Sundog", words: [] },
                        115: { name: "Aurora Veil", words: [] },
                        116: { name: "Cloud Throne", words: [] },
                        117: { name: "Celestial Path", words: [] },
                        118: { name: "Eternal Sunset", words: [] },
                        119: { name: "Sky Crown", words: [] },
                        120: { name: "Infinite Sky", words: [] }
                    }
                },
                // WORLD 5: DRAGON'S PEAK (600 words)
                world5: {
                    name: "Dragon's Peak",
                    icon: "üêâ",
                    unitType: "Scale",
                    units: {
                        121: { name: "First Scale", words: [] },
                        122: { name: "Hatchling Warmth", words: [] },
                        123: { name: "Claw's Edge", words: [] },
                        124: { name: "Smoke Breath", words: [] },
                        125: { name: "Fledgling Wing", words: [] },
                        126: { name: "Nest Fire", words: [] },
                        127: { name: "Small Roar", words: [] },
                        128: { name: "Treasure Glint", words: [] },
                        129: { name: "Cave Warmth", words: [] },
                        130: { name: "Dragon's Eye", words: [] },
                        131: { name: "Ember Scale", words: [] },
                        132: { name: "Iron Scale", words: [] },
                        133: { name: "Flame Tongue", words: [] },
                        134: { name: "Wing Stretch", words: [] },
                        135: { name: "Mountain Claw", words: [] },
                        136: { name: "Gold Hoard", words: [] },
                        137: { name: "Lava Vein", words: [] },
                        138: { name: "Storm Flight", words: [] },
                        139: { name: "Roaring Voice", words: [] },
                        140: { name: "Ancient Pattern", words: [] },
                        141: { name: "Dragonfire", words: [] },
                        142: { name: "Thunder Scale", words: [] },
                        143: { name: "Elder's Wisdom", words: [] },
                        144: { name: "Sky Sovereign", words: [] },
                        145: { name: "Volcanic Heart", words: [] },
                        146: { name: "Diamond Scale", words: [] },
                        147: { name: "Wyrm's Legacy", words: [] },
                        148: { name: "Crown of Claws", words: [] },
                        149: { name: "Eternal Flame", words: [] },
                        150: { name: "Ascendant Dragon", words: [] }
                    }
                },
                // WORLD 6: STAR FORGE (600 words)
                world6: {
                    name: "Star Forge",
                    icon: "‚≠ê",
                    unitType: "Star",
                    units: {
                        151: { name: "First Light", words: [] },
                        152: { name: "Twinkling Hope", words: [] },
                        153: { name: "Distant Glow", words: [] },
                        154: { name: "Guiding North", words: [] },
                        155: { name: "Falling Wish", words: [] },
                        156: { name: "Evening Star", words: [] },
                        157: { name: "Constellation", words: [] },
                        158: { name: "Starlight Path", words: [] },
                        159: { name: "Moon's Companion", words: [] },
                        160: { name: "Dawn's Last Stand", words: [] },
                        161: { name: "Binary System", words: [] },
                        162: { name: "Pulsar Rhythm", words: [] },
                        163: { name: "Nebula Heart", words: [] },
                        164: { name: "Solar Flare", words: [] },
                        165: { name: "Orbiting Planet", words: [] },
                        166: { name: "Galaxy Spiral", words: [] },
                        167: { name: "Supergiant", words: [] },
                        168: { name: "Star Cluster", words: [] },
                        169: { name: "Light Year", words: [] },
                        170: { name: "Solar Wind", words: [] },
                        171: { name: "Supernova", words: [] },
                        172: { name: "Black Hole Wisdom", words: [] },
                        173: { name: "Quasar Power", words: [] },
                        174: { name: "Cosmic Web", words: [] },
                        175: { name: "Milky Way", words: [] },
                        176: { name: "Andromeda", words: [] },
                        177: { name: "Universal Truth", words: [] },
                        178: { name: "Celestial Crown", words: [] },
                        179: { name: "Eternal Glow", words: [] },
                        180: { name: "Star Forge Heart", words: [] }
                    }
                }
            };

            // ---------- INGOT DIFFICULTY DATABASE ----------
            const ingotDifficulty = {
                // WORLD 1: Grand Forge (Ingots 1-30)
                1: { baseChance: 100, tier: "Foundation" },
                2: { baseChance: 99, tier: "Foundation" },
                3: { baseChance: 98, tier: "Foundation" },
                4: { baseChance: 97, tier: "Foundation" },
                5: { baseChance: 96, tier: "Foundation" },
                6: { baseChance: 95, tier: "Foundation" },
                7: { baseChance: 94, tier: "Foundation" },
                8: { baseChance: 93, tier: "Foundation" },
                9: { baseChance: 92, tier: "Foundation" },
                10: { baseChance: 91, tier: "Foundation" },
                11: { baseChance: 90, tier: "Crafting" },
                12: { baseChance: 89, tier: "Crafting" },
                13: { baseChance: 88, tier: "Crafting" },
                14: { baseChance: 87, tier: "Crafting" },
                15: { baseChance: 86, tier: "Crafting" },
                16: { baseChance: 85, tier: "Crafting" },
                17: { baseChance: 84, tier: "Crafting" },
                18: { baseChance: 83, tier: "Crafting" },
                19: { baseChance: 82, tier: "Crafting" },
                20: { baseChance: 81, tier: "Crafting" },
                21: { baseChance: 80, tier: "Masterwork" },
                22: { baseChance: 79, tier: "Masterwork" },
                23: { baseChance: 78, tier: "Masterwork" },
                24: { baseChance: 77, tier: "Masterwork" },
                25: { baseChance: 76, tier: "Masterwork" },
                26: { baseChance: 75, tier: "Masterwork" },
                27: { baseChance: 74, tier: "Masterwork" },
                28: { baseChance: 73, tier: "Masterwork" },
                29: { baseChance: 72, tier: "Masterwork" },
                30: { baseChance: 71, tier: "Masterwork" },
                
                // WORLD 2: Enchanted Forest (Seeds 31-60)
                31: { baseChance: 70, tier: "Sprouting" },
                32: { baseChance: 69, tier: "Sprouting" },
                33: { baseChance: 68, tier: "Sprouting" },
                34: { baseChance: 67, tier: "Sprouting" },
                35: { baseChance: 66, tier: "Sprouting" },
                36: { baseChance: 65, tier: "Sprouting" },
                37: { baseChance: 64, tier: "Sprouting" },
                38: { baseChance: 63, tier: "Sprouting" },
                39: { baseChance: 62, tier: "Sprouting" },
                40: { baseChance: 61, tier: "Sprouting" },
                41: { baseChance: 60, tier: "Blooming" },
                42: { baseChance: 59, tier: "Blooming" },
                43: { baseChance: 58, tier: "Blooming" },
                44: { baseChance: 57, tier: "Blooming" },
                45: { baseChance: 56, tier: "Blooming" },
                46: { baseChance: 55, tier: "Blooming" },
                47: { baseChance: 54, tier: "Blooming" },
                48: { baseChance: 53, tier: "Blooming" },
                49: { baseChance: 52, tier: "Blooming" },
                50: { baseChance: 51, tier: "Blooming" },
                51: { baseChance: 50, tier: "Ancient" },
                52: { baseChance: 49, tier: "Ancient" },
                53: { baseChance: 48, tier: "Ancient" },
                54: { baseChance: 47, tier: "Ancient" },
                55: { baseChance: 46, tier: "Ancient" },
                56: { baseChance: 45, tier: "Ancient" },
                57: { baseChance: 44, tier: "Ancient" },
                58: { baseChance: 43, tier: "Ancient" },
                59: { baseChance: 42, tier: "Ancient" },
                60: { baseChance: 41, tier: "Ancient" },
                
                // WORLD 3: Crystal Caverns (Geodes 61-90)
                61: { baseChance: 40, tier: "Rough" },
                62: { baseChance: 39, tier: "Rough" },
                63: { baseChance: 38, tier: "Rough" },
                64: { baseChance: 37, tier: "Rough" },
                65: { baseChance: 36, tier: "Rough" },
                66: { baseChance: 35, tier: "Rough" },
                67: { baseChance: 34, tier: "Rough" },
                68: { baseChance: 33, tier: "Rough" },
                69: { baseChance: 32, tier: "Rough" },
                70: { baseChance: 31, tier: "Rough" },
                71: { baseChance: 30, tier: "Revealed" },
                72: { baseChance: 29, tier: "Revealed" },
                73: { baseChance: 28, tier: "Revealed" },
                74: { baseChance: 27, tier: "Revealed" },
                75: { baseChance: 26, tier: "Revealed" },
                76: { baseChance: 25, tier: "Revealed" },
                77: { baseChance: 24, tier: "Revealed" },
                78: { baseChance: 23, tier: "Revealed" },
                79: { baseChance: 22, tier: "Revealed" },
                80: { baseChance: 21, tier: "Revealed" },
                81: { baseChance: 20, tier: "Perfect" },
                82: { baseChance: 19, tier: "Perfect" },
                83: { baseChance: 18, tier: "Perfect" },
                84: { baseChance: 17, tier: "Perfect" },
                85: { baseChance: 16, tier: "Perfect" },
                86: { baseChance: 15, tier: "Perfect" },
                87: { baseChance: 14, tier: "Perfect" },
                88: { baseChance: 13, tier: "Perfect" },
                89: { baseChance: 12, tier: "Perfect" },
                90: { baseChance: 11, tier: "Perfect" },
                
                // WORLD 4: Sky Citadel (Clouds 91-120)
                91: { baseChance: 10, tier: "Drifting" },
                92: { baseChance: 10, tier: "Drifting" },
                93: { baseChance: 10, tier: "Drifting" },
                94: { baseChance: 10, tier: "Drifting" },
                95: { baseChance: 10, tier: "Drifting" },
                96: { baseChance: 9, tier: "Drifting" },
                97: { baseChance: 9, tier: "Drifting" },
                98: { baseChance: 9, tier: "Drifting" },
                99: { baseChance: 9, tier: "Drifting" },
                100: { baseChance: 9, tier: "Drifting" },
                101: { baseChance: 8, tier: "Powerful" },
                102: { baseChance: 8, tier: "Powerful" },
                103: { baseChance: 8, tier: "Powerful" },
                104: { baseChance: 8, tier: "Powerful" },
                105: { baseChance: 8, tier: "Powerful" },
                106: { baseChance: 7, tier: "Powerful" },
                107: { baseChance: 7, tier: "Powerful" },
                108: { baseChance: 7, tier: "Powerful" },
                109: { baseChance: 7, tier: "Powerful" },
                110: { baseChance: 7, tier: "Powerful" },
                111: { baseChance: 6, tier: "Masterful" },
                112: { baseChance: 6, tier: "Masterful" },
                113: { baseChance: 6, tier: "Masterful" },
                114: { baseChance: 6, tier: "Masterful" },
                115: { baseChance: 6, tier: "Masterful" },
                116: { baseChance: 5, tier: "Masterful" },
                117: { baseChance: 5, tier: "Masterful" },
                118: { baseChance: 5, tier: "Masterful" },
                119: { baseChance: 5, tier: "Masterful" },
                120: { baseChance: 5, tier: "Masterful" },
                
                // WORLD 5: Dragon's Peak (Scales 121-150)
                121: { baseChance: 5, tier: "Hatchling" },
                122: { baseChance: 5, tier: "Hatchling" },
                123: { baseChance: 5, tier: "Hatchling" },
                124: { baseChance: 5, tier: "Hatchling" },
                125: { baseChance: 5, tier: "Hatchling" },
                126: { baseChance: 4, tier: "Hatchling" },
                127: { baseChance: 4, tier: "Hatchling" },
                128: { baseChance: 4, tier: "Hatchling" },
                129: { baseChance: 4, tier: "Hatchling" },
                130: { baseChance: 4, tier: "Hatchling" },
                131: { baseChance: 4, tier: "Growing" },
                132: { baseChance: 4, tier: "Growing" },
                133: { baseChance: 4, tier: "Growing" },
                134: { baseChance: 4, tier: "Growing" },
                135: { baseChance: 4, tier: "Growing" },
                136: { baseChance: 3, tier: "Growing" },
                137: { baseChance: 3, tier: "Growing" },
                138: { baseChance: 3, tier: "Growing" },
                139: { baseChance: 3, tier: "Growing" },
                140: { baseChance: 3, tier: "Growing" },
                141: { baseChance: 3, tier: "Elder" },
                142: { baseChance: 3, tier: "Elder" },
                143: { baseChance: 3, tier: "Elder" },
                144: { baseChance: 3, tier: "Elder" },
                145: { baseChance: 3, tier: "Elder" },
                146: { baseChance: 2, tier: "Elder" },
                147: { baseChance: 2, tier: "Elder" },
                148: { baseChance: 2, tier: "Elder" },
                149: { baseChance: 2, tier: "Elder" },
                150: { baseChance: 2, tier: "Elder" },
                
                // WORLD 6: Star Forge (Stars 151-180)
                151: { baseChance: 2, tier: "Twinkling" },
                152: { baseChance: 2, tier: "Twinkling" },
                153: { baseChance: 2, tier: "Twinkling" },
                154: { baseChance: 2, tier: "Twinkling" },
                155: { baseChance: 2, tier: "Twinkling" },
                156: { baseChance: 2, tier: "Twinkling" },
                157: { baseChance: 2, tier: "Twinkling" },
                158: { baseChance: 2, tier: "Twinkling" },
                159: { baseChance: 2, tier: "Twinkling" },
                160: { baseChance: 2, tier: "Twinkling" },
                161: { baseChance: 1, tier: "Bright" },
                162: { baseChance: 1, tier: "Bright" },
                163: { baseChance: 1, tier: "Bright" },
                164: { baseChance: 1, tier: "Bright" },
                165: { baseChance: 1, tier: "Bright" },
                166: { baseChance: 1, tier: "Bright" },
                167: { baseChance: 1, tier: "Bright" },
                168: { baseChance: 1, tier: "Bright" },
                169: { baseChance: 1, tier: "Bright" },
                170: { baseChance: 1, tier: "Bright" },
                171: { baseChance: 1, tier: "Cosmic" },
                172: { baseChance: 1, tier: "Cosmic" },
                173: { baseChance: 1, tier: "Cosmic" },
                174: { baseChance: 1, tier: "Cosmic" },
                175: { baseChance: 1, tier: "Cosmic" },
                176: { baseChance: 1, tier: "Cosmic" },
                177: { baseChance: 1, tier: "Cosmic" },
                178: { baseChance: 1, tier: "Cosmic" },
                179: { baseChance: 1, tier: "Cosmic" },
                180: { baseChance: 1, tier: "Cosmic" }
            };

            // ---------- PLAYER PERFORMANCE TRACKING ----------
            let playerPerformance = {
                currentStreak: 0,
                bestStreak: 0,
                lastAccuracy: 100,
                lastAttemptFailed: false,
                lastPlayedDate: new Date().toISOString(),
                totalRiskBonus: 0,
                ingotHistory: [],
                worldProgress: {
                    1: { completed: 0, failed: 0, bestTime: null },
                    2: { completed: 0, failed: 0, bestTime: null },
                    3: { completed: 0, failed: 0, bestTime: null },
                    4: { completed: 0, failed: 0, bestTime: null },
                    5: { completed: 0, failed: 0, bestTime: null },
                    6: { completed: 0, failed: 0, bestTime: null }
                }
            };

            // ---------- WORLD DATA STRUCTURE ----------
            const worlds = {
                1: {
                    id: 1,
                    name: "Grand Forge",
                    icon: "‚öíÔ∏è",
                    unitName: "INGOT",
                    unlocked: true,
                    completed: false,
                    totalWords: 600,
                    units: Array.from({ length: 30 }, (_, i) => {
                        const unitId = i + 1;
                        const unitData = MASTER_WORDS.world1.units[unitId];
                        return {
                            id: unitId,
                            name: unitData ? unitData.name : "???",
                            wordsCompleted: 0,
                            totalWords: 20,
                            unlocked: unitId === 1
                        };
                    })
                },
                2: {
                    id: 2,
                    name: "Enchanted Forest",
                    icon: "üå≥",
                    unitName: "SEED",
                    unlocked: false,
                    completed: false,
                    totalWords: 600,
                    units: Array.from({ length: 30 }, (_, i) => {
                        const unitId = i + 31;
                        const unitData = MASTER_WORDS.world2.units[unitId];
                        return {
                            id: unitId,
                            name: unitData ? unitData.name : "???",
                            wordsCompleted: 0,
                            totalWords: 20,
                            unlocked: false
                        };
                    })
                },
                3: {
                    id: 3,
                    name: "Crystal Caverns",
                    icon: "üíé",
                    unitName: "GEODE",
                    unlocked: false,
                    completed: false,
                    totalWords: 600,
                    units: Array.from({ length: 30 }, (_, i) => {
                        const unitId = i + 61;
                        const unitData = MASTER_WORDS.world3.units[unitId];
                        return {
                            id: unitId,
                            name: unitData ? unitData.name : "???",
                            wordsCompleted: 0,
                            totalWords: 20,
                            unlocked: false
                        };
                    })
                },
                4: {
                    id: 4,
                    name: "Sky Citadel",
                    icon: "‚òÅÔ∏è",
                    unitName: "CLOUD",
                    unlocked: false,
                    completed: false,
                    totalWords: 600,
                    units: Array.from({ length: 30 }, (_, i) => {
                        const unitId = i + 91;
                        const unitData = MASTER_WORDS.world4.units[unitId];
                        return {
                            id: unitId,
                            name: unitData ? unitData.name : "???",
                            wordsCompleted: 0,
                            totalWords: 20,
                            unlocked: false
                        };
                    })
                },
                5: {
                    id: 5,
                    name: "Dragon's Peak",
                    icon: "üêâ",
                    unitName: "SCALE",
                    unlocked: false,
                    completed: false,
                    totalWords: 600,
                    units: Array.from({ length: 30 }, (_, i) => {
                        const unitId = i + 121;
                        const unitData = MASTER_WORDS.world5.units[unitId];
                        return {
                            id: unitId,
                            name: unitData ? unitData.name : "???",
                            wordsCompleted: 0,
                            totalWords: 20,
                            unlocked: false
                        };
                    })
                },
                6: {
                    id: 6,
                    name: "Star Forge",
                    icon: "‚≠ê",
                    unitName: "STAR",
                    unlocked: false,
                    completed: false,
                    totalWords: 600,
                    units: Array.from({ length: 30 }, (_, i) => {
                        const unitId = i + 151;
                        const unitData = MASTER_WORDS.world6.units[unitId];
                        return {
                            id: unitId,
                            name: unitData ? unitData.name : "???",
                            wordsCompleted: 0,
                            totalWords: 20,
                            unlocked: false
                        };
                    })
                }
            };

            // ---------- GAME STATE ----------
            let currentWorld = 1;
            let currentUnit = 1;
            let currentLetters = [];
            let completedWords = [];
            let activeWordIndex = null;
            let currentPosition = 0;
            
            // Stats tracking
            let gameStartTime = null;
            let totalTaps = 0;
            let correctTaps = 0;
            let gameCompleted = false;

            // Queue for word cards
            let wordCardQueue = [];
            let showingWordCard = false;

            // ---------- HELPER FUNCTIONS ----------
            function generateInitialLetters() {
                const words = getCurrentUnitWords();
                if (!words || words.length === 0) return [];
                
                let allChars = [];
                words.forEach(entry => {
                    allChars.push(...entry.word.split(''));
                });
                for (let i = allChars.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [allChars[i], allChars[j]] = [allChars[j], allChars[i]];
                }
                return allChars;
            }

            function getCurrentUnitWords() {
                try {
                    const unitWords = MASTER_WORDS[`world${currentWorld}`].units[currentUnit].words;
                    return unitWords || [];
                } catch (e) {
                    return [];
                }
            }

            function calculateSuccessChance(ingotId) {
                try {
                    const difficulty = ingotDifficulty[ingotId] || { baseChance: 50, tier: "Unknown" };
                    let baseChance = difficulty.baseChance;
                    
                    let modifiers = 0;
                    
                    // Simple modifier calculation
                    const streakBonus = Math.floor(playerPerformance.currentStreak / 3) * 5;
                    modifiers += streakBonus;
                    
                    if (playerPerformance.lastAccuracy === 100) {
                        modifiers += 10;
                    }
                    
                    const worldCompleted = playerPerformance.worldProgress[currentWorld].completed;
                    const masteryBonus = Math.floor(worldCompleted / 5) * 2;
                    modifiers += masteryBonus;
                    
                    if (playerPerformance.lastAttemptFailed) {
                        modifiers -= 10;
                    }
                    
                    const daysSinceLastPlay = Math.floor((new Date() - new Date(playerPerformance.lastPlayedDate)) / (1000 * 60 * 60 * 24));
                    if (daysSinceLastPlay > 7) {
                        modifiers -= 5;
                    }
                    
                    modifiers = Math.min(modifiers, 30);
                    modifiers = Math.max(modifiers, -20);
                    
                    let finalChance = baseChance + modifiers;
                    finalChance = Math.min(finalChance, 100);
                    finalChance = Math.max(finalChance, 1);
                    
                    return {
                        final: finalChance,
                        base: baseChance,
                        tier: difficulty.tier
                    };
                } catch (e) {
                    console.error("Error calculating chance:", e);
                    return { final: 50, base: 50, tier: "Unknown" };
                }
            }

            function calculateRiskBonus(baseChance, actualChance, success) {
                if (!success) return 0;
                const riskFactor = 100 - actualChance;
                const bonus = riskFactor * 10;
                return Math.min(bonus, 1000);
            }

            function getDaysSince(dateString) {
                const last = new Date(dateString);
                const now = new Date();
                const diffTime = Math.abs(now - last);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays;
            }

            function updateWorldDisplay() {
                const world = worlds[currentWorld];
                document.getElementById('worldIcon').innerText = world.icon;
                document.getElementById('worldName').innerText = world.name;
                document.getElementById('unitLabel').innerText = world.unitName + 'S';
                
                const selector = document.getElementById('unitSelector');
                selector.innerHTML = '';
                world.units.forEach((unit) => {
                    if (unit.unlocked) {
                        const option = document.createElement('option');
                        option.value = unit.id;
                        const unitData = MASTER_WORDS[`world${currentWorld}`].units[unit.id];
                        const unitName = unitData ? unitData.name : "???";
                        option.innerText = `${world.unitName} ${unit.id.toString().padStart(2, '0')} ¬∑ ${unitName}`;
                        if (unit.id === currentUnit) option.selected = true;
                        selector.appendChild(option);
                    }
                });

                const grid = document.getElementById('unitGrid');
                grid.innerHTML = '';
                world.units.forEach(unit => {
                    if (unit.unlocked) {
                        const unitData = MASTER_WORDS[`world${currentWorld}`].units[unit.id];
                        const unitName = unitData ? unitData.name : "???";
                        const card = document.createElement('div');
                        card.className = `unit-card ${unit.id === currentUnit ? 'active-unit' : ''} ${unit.wordsCompleted === 20 ? 'completed' : ''}`;
                        card.innerHTML = `
                            <div class="unit-number">${world.unitName} ${unit.id.toString().padStart(2, '0')}</div>
                            <div class="unit-name">${unitName}</div>
                            <div class="unit-progress">${unit.wordsCompleted}/20</div>
                            <div class="unit-progress-bar">
                                <div class="unit-progress-fill" style="width: ${(unit.wordsCompleted/20)*100}%"></div>
                            </div>
                        `;
                        card.addEventListener('click', () => {
                            if (unit.id !== currentUnit) {
                                currentUnit = unit.id;
                                resetForNewUnit();
                                updateWorldDisplay();
                            }
                        });
                        grid.appendChild(card);
                    }
                });

                const totalCompleted = world.units.reduce((sum, unit) => sum + unit.wordsCompleted, 0);
                document.getElementById('progressDisplay').innerText = `${totalCompleted}/${world.totalWords}`;
            }

            function resetForNewUnit() {
                currentLetters = generateInitialLetters();
                completedWords = [];
                activeWordIndex = null;
                currentPosition = 0;
                gameStartTime = Date.now();
                totalTaps = 0;
                correctTaps = 0;
                gameCompleted = false;
                wordCardQueue = [];
                showingWordCard = false;
                renderAll();
            }

            // ---------- SFR SYSTEM ----------
            function calculateSFR(timeSeconds, accuracy, totalTapsCount, correctTapsCount) {
                const accuracyScore = Math.round(accuracy * 2);
                const speedScore = timeSeconds > 0 ? Math.round(100000 / timeSeconds) : 2000;
                const perfectionBonus = (accuracy === 100 && totalTapsCount === correctTapsCount) ? 100 : 0;
                let total = accuracyScore + speedScore + perfectionBonus;
                total = Math.min(total, 1600);
                return total;
            }

            function getRatingFromScore(score) {
                if (score >= 1400) return { title: "LEGEND", emoji: "üî•" };
                if (score >= 1200) return { title: "MASTER", emoji: "üëë" };
                if (score >= 1000) return { title: "EXPERT", emoji: "‚ö°" };
                if (score >= 800) return { title: "ADVANCED", emoji: "üõ°Ô∏è" };
                if (score >= 600) return { title: "INTERMEDIATE", emoji: "üìò" };
                return { title: "NOVICE", emoji: "üå±" };
            }

            function formatTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }

            // ---------- MOCK LEADERBOARD ----------
            const mockLeaderboard = [
                { name: "LIAM", score: 1420, time: "1:24", accuracy: 98, rank: 1 },
                { name: "ELENA", score: 1380, time: "1:28", accuracy: 99, rank: 2 },
                { name: "NOAH", score: 1350, time: "1:31", accuracy: 97, rank: 3 },
                { name: "SOFIA", score: 1310, time: "1:35", accuracy: 98, rank: 4 },
                { name: "OLIVER", score: 1280, time: "1:38", accuracy: 96, rank: 5 },
                { name: "MIA", score: 1240, time: "1:42", accuracy: 97, rank: 6 },
                { name: "LUCAS", score: 1210, time: "1:45", accuracy: 95, rank: 7 },
                { name: "AMELIA", score: 1180, time: "1:48", accuracy: 96, rank: 8 },
                { name: "ELIJAH", score: 1150, time: "1:51", accuracy: 94, rank: 9 },
                { name: "HARPER", score: 1120, time: "1:54", accuracy: 95, rank: 10 }
            ];

            // ---------- POPUP FUNCTIONS ----------
            function showWordCard(wordData) {
                wordCardQueue.push(wordData);
                processWordCardQueue();
            }

            function processWordCardQueue() {
                if (showingWordCard || wordCardQueue.length === 0) return;
                
                showingWordCard = true;
                const wordData = wordCardQueue.shift();
                
                const overlay = document.getElementById('popupOverlay');
                overlay.innerHTML = '';
                
                const card = document.createElement('div');
                card.className = 'word-card';
                card.innerHTML = `
                    <div class="word-emoji">${wordData.emoji}</div>
                    <div class="word-title">${wordData.word.toUpperCase()}</div>
                    <div class="word-sentence">${wordData.sentence}</div>
                    <button class="collect-btn" id="collectWordBtn">‚ú® COLLECT</button>
                `;
                
                overlay.appendChild(card);
                overlay.classList.remove('hidden');
                
                document.getElementById('collectWordBtn').addEventListener('click', () => {
                    overlay.classList.add('hidden');
                    showingWordCard = false;
                    processWordCardQueue();
                });
                
                tg?.HapticFeedback?.notificationOccurred?.('success');
            }

            // FIXED: Ingot Complete Popup with delay for leaderboard
            function showIngotCompletePopup() {
                const overlay = document.getElementById('popupOverlay');
                const world = worlds[currentWorld];
                const unit = world.units.find(u => u.id === currentUnit);
                const unitData = MASTER_WORDS[`world${currentWorld}`].units[currentUnit];
                
                const timeElapsed = gameStartTime ? Math.floor((Date.now() - gameStartTime) / 1000) : 0;
                const accuracy = totalTaps === 0 ? 100 : Math.round((correctTaps / totalTaps) * 100);
                const playerSFR = calculateSFR(timeElapsed, accuracy, totalTaps, correctTaps);
                const playerRating = getRatingFromScore(playerSFR);
                
                overlay.innerHTML = '';
                
                const card = document.createElement('div');
                card.className = 'ingot-card';
                card.innerHTML = `
                    <div class="ingot-emoji">‚öíÔ∏è</div>
                    <div class="ingot-title">INGOT COMPLETE!</div>
                    <div class="ingot-sub">${world.unitName} ${currentUnit.toString().padStart(2, '0')} ¬∑ ${unitData.name}</div>
                    
                    <div class="ingot-stats">
                        <div class="ingot-stat">
                            <div class="ingot-stat-value">${playerSFR}</div>
                            <div class="ingot-stat-label">SFR</div>
                        </div>
                        <div class="ingot-stat">
                            <div class="ingot-stat-value">${playerRating.emoji}</div>
                            <div class="ingot-stat-label">${playerRating.title}</div>
                        </div>
                        <div class="ingot-stat">
                            <div class="ingot-stat-value">${formatTime(timeElapsed)}</div>
                            <div class="ingot-stat-label">TIME</div>
                        </div>
                    </div>
                    
                    <div class="ingot-buttons">
                        <button class="ingot-btn" id="viewLeaderboardBtn">üèÜ LEADERBOARD</button>
                        <button class="ingot-btn secondary" id="continueBtn">‚è© CONTINUE</button>
                    </div>
                `;
                
                overlay.appendChild(card);
                overlay.classList.remove('hidden');
                
                // FIXED: Leaderboard button with delay
                document.getElementById('viewLeaderboardBtn').addEventListener('click', () => {
                    overlay.classList.add('hidden');
                    // Small delay to ensure first popup is gone
                    setTimeout(() => {
                        showLeaderboardPopup(true);
                    }, 100);
                });
                
                document.getElementById('continueBtn').addEventListener('click', () => {
                    overlay.classList.add('hidden');
                    
                    const allUnitsCompleted = world.units.every(u => u.wordsCompleted === 20);
                    if (allUnitsCompleted) {
                        setTimeout(() => {
                            showWorldArtifactPopup();
                        }, 100);
                    } else {
                        const nextIngotId = currentUnit + 1;
                        const nextUnit = world.units.find(u => u.id === nextIngotId);
                        if (nextUnit) {
                            nextUnit.unlocked = true;
                            setTimeout(() => {
                                showNextIngotPreview();
                            }, 100);
                        }
                    }
                });
                
                tg?.HapticFeedback?.notificationOccurred?.('success');
            }

            // Simplified Next Ingot Preview Popup
            function showNextIngotPreview() {
                const nextIngotId = currentUnit + 1;
                const world = worlds[currentWorld];
                
                if (!world) {
                    console.error("World not found");
                    return;
                }
                
                const nextUnitData = MASTER_WORDS[`world${currentWorld}`].units[nextIngotId];
                
                if (!nextUnitData) {
                    console.error("Next unit data not found");
                    return;
                }
                
                // Calculate chance safely
                let chance;
                try {
                    chance = calculateSuccessChance(nextIngotId);
                } catch (e) {
                    console.error("Error calculating chance:", e);
                    chance = { final: 50, base: 50, tier: "Unknown" };
                }
                
                // Determine color class
                let chanceColorClass = 'chance-medium';
                if (chance.final >= 80) {
                    chanceColorClass = 'chance-high';
                } else if (chance.final < 50) {
                    chanceColorClass = 'chance-low';
                }
                
                const unitName = nextUnitData.name || "Unknown";
                
                const overlay = document.getElementById('popupOverlay');
                overlay.innerHTML = '';
                
                const card = document.createElement('div');
                card.className = 'preview-card';
                card.innerHTML = `
                    <div class="preview-title">‚öíÔ∏è NEXT INGOT</div>
                    <div class="preview-ingot">${world.unitName} ${nextIngotId.toString().padStart(2, '0')} ¬∑ ${unitName}</div>
                    
                    <div class="chance-container">
                        <div class="chance-label">CHANCE OF SUCCESS</div>
                        <div class="chance-value ${chanceColorClass}">${chance.final}%</div>
                        <div class="chance-bar">
                            <div class="chance-bar-fill" style="width: ${chance.final}%"></div>
                        </div>
                    </div>
                    
                    <div class="preview-buttons">
                        <button class="preview-btn" id="forgeAheadBtn">‚öíÔ∏è FORGE AHEAD</button>
                        <button class="preview-btn secondary" id="practiceBtn">üî® PRACTICE</button>
                    </div>
                `;
                
                overlay.appendChild(card);
                overlay.classList.remove('hidden');
                
                document.getElementById('forgeAheadBtn').addEventListener('click', () => {
                    overlay.classList.add('hidden');
                    currentUnit = nextIngotId;
                    resetForNewUnit();
                    updateWorldDisplay();
                });
                
                document.getElementById('practiceBtn').addEventListener('click', () => {
                    overlay.classList.add('hidden');
                    showPracticeMode();
                });
                
                tg?.HapticFeedback?.notificationOccurred?.('success');
            }

            // Practice Mode Popup
            function showPracticeMode() {
                const world = worlds[currentWorld];
                const overlay = document.getElementById('popupOverlay');
                
                const completedIngots = world.units.filter(u => u.wordsCompleted === 20 && u.id !== currentUnit);
                
                overlay.innerHTML = '';
                
                const card = document.createElement('div');
                card.className = 'practice-card';
                card.innerHTML = `
                    <div class="practice-title">üî® PRACTICE MODE</div>
                    <div class="practice-list" id="practiceList">
                        ${completedIngots.map(unit => {
                            const unitData = MASTER_WORDS[`world${currentWorld}`].units[unit.id];
                            const unitName = unitData ? unitData.name : "Unknown";
                            return `
                                <div class="practice-item" data-id="${unit.id}">
                                    <div class="practice-item-left">
                                        <span class="practice-icon">‚öíÔ∏è</span>
                                        <span class="practice-name">${world.unitName} ${unit.id.toString().padStart(2, '0')} ¬∑ ${unitName}</span>
                                    </div>
                                    <span class="practice-chance">${unit.wordsCompleted}/20</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <div class="preview-buttons">
                        <button class="preview-btn secondary" id="backBtn">‚Üê BACK</button>
                    </div>
                `;
                
                overlay.appendChild(card);
                overlay.classList.remove('hidden');
                
                document.querySelectorAll('.practice-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const practiceId = parseInt(item.dataset.id);
                        overlay.classList.add('hidden');
                        currentUnit = practiceId;
                        resetForNewUnit();
                        updateWorldDisplay();
                    });
                });
                
                document.getElementById('backBtn').addEventListener('click', () => {
                    overlay.classList.add('hidden');
                    showNextIngotPreview();
                });
            }

            // World Artifact Popup
            function showWorldArtifactPopup() {
                const overlay = document.getElementById('popupOverlay');
                const world = worlds[currentWorld];
                
                overlay.innerHTML = '';
                
                const card = document.createElement('div');
                card.className = 'world-card';
                card.innerHTML = `
                    <div class="world-emoji">üèÜ</div>
                    <div class="world-title">WORLD COMPLETE!</div>
                    <div class="world-sub">${world.name}</div>
                    <div class="ingot-stats">
                        <div class="ingot-stat">
                            <div class="ingot-stat-value">${world.totalWords}</div>
                            <div class="ingot-stat-label">WORDS</div>
                        </div>
                        <div class="ingot-stat">
                            <div class="ingot-stat-value">30</div>
                            <div class="ingot-stat-label">INGOTS</div>
                        </div>
                    </div>
                    <div class="artifact-tap">‚ú® All 30 ingots forged ¬∑ tap for leaderboard ‚ú®</div>
                `;
                
                overlay.appendChild(card);
                overlay.classList.remove('hidden');
                
                card.addEventListener('click', (e) => {
                    e.stopPropagation();
                    overlay.classList.add('hidden');
                    
                    if (currentWorld < 6) {
                        worlds[currentWorld + 1].unlocked = true;
                        setTimeout(() => {
                            showWorldUnlockPopup(currentWorld + 1);
                        }, 100);
                    } else {
                        showLeaderboardPopup();
                    }
                });
                
                tg?.HapticFeedback?.notificationOccurred?.('success');
            }

            function showWorldUnlockPopup(worldId) {
                const world = worlds[worldId];
                const overlay = document.getElementById('popupOverlay');
                
                const card = document.createElement('div');
                card.className = 'artifact-card';
                card.innerHTML = `
                    <div class="artifact-emoji">${world.icon}</div>
                    <div class="artifact-title">NEW WORLD</div>
                    <div class="artifact-title">UNLOCKED!</div>
                    <div class="artifact-sub">${world.name}</div>
                    <div class="artifact-tap">‚ú® tap to continue ‚ú®</div>
                `;
                
                overlay.innerHTML = '';
                overlay.appendChild(card);
                overlay.classList.remove('hidden');
                
                card.addEventListener('click', () => {
                    overlay.classList.add('hidden');
                });
            }

            // FIXED: Leaderboard Popup with proper back navigation
            function showLeaderboardPopup(fromCompletion = false) {
                const overlay = document.getElementById('popupOverlay');
                
                const timeElapsed = gameStartTime ? Math.floor((Date.now() - gameStartTime) / 1000) : 0;
                const accuracy = totalTaps === 0 ? 100 : Math.round((correctTaps / totalTaps) * 100);
                const playerSFR = calculateSFR(timeElapsed, accuracy, totalTaps, correctTaps);
                const playerRating = getRatingFromScore(playerSFR);
                
                const leaderboardWithPlayer = [...mockLeaderboard];
                const yourEntry = {
                    name: "YOU",
                    score: playerSFR,
                    time: formatTime(timeElapsed),
                    accuracy: accuracy,
                    rank: 0
                };
                
                leaderboardWithPlayer.push(yourEntry);
                leaderboardWithPlayer.sort((a, b) => b.score - a.score);
                leaderboardWithPlayer.forEach((entry, index) => {
                    entry.rank = index + 1;
                });
                
                let leaderboardHtml = '';
                leaderboardWithPlayer.forEach(entry => {
                    const youClass = entry.name === 'YOU' ? ' you' : '';
                    const rating = entry.name === 'YOU' ? playerRating : getRatingFromScore(entry.score);
                    
                    let crownEmoji = '';
                    if (entry.rank === 1) crownEmoji = 'üëë';
                    else if (entry.rank === 2) crownEmoji = '‚ö°';
                    else if (entry.rank === 3) crownEmoji = 'ü•â';
                    
                    leaderboardHtml += `
                        <div class="leaderboard-row${youClass}">
                            <span class="rank">${entry.rank}.</span>
                            <span class="player-name">${entry.name}</span>
                            <span class="score">${entry.score}</span>
                            <span class="rating-badge">${rating.emoji} ${rating.title}</span>
                            <span class="crown">${crownEmoji}</span>
                        </div>
                    `;
                });

                const yourRank = leaderboardWithPlayer.find(e => e.name === 'YOU').rank;
                
                overlay.innerHTML = '';
                
                const leaderboardCard = document.createElement('div');
                leaderboardCard.className = 'leaderboard-card';
                leaderboardCard.innerHTML = `
                    <div class="leaderboard-title">‚öíÔ∏è ${worlds[currentWorld].name} ¬∑ INGOT ${currentUnit}</div>
                    
                    <div class="score-highlight">
                        <div class="score-title">SPELLFORGE RATING (SFR)</div>
                        <div class="score-number">${playerSFR}</div>
                        <div class="score-rating">${playerRating.emoji} ${playerRating.title}</div>
                    </div>
                    
                    <div class="stats-row">
                        <div class="stat-item">
                            <div class="stat-value">${formatTime(timeElapsed)}</div>
                            <div class="stat-label">TIME</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${accuracy}%</div>
                            <div class="stat-label">ACCURACY</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${correctTaps}/${totalTaps}</div>
                            <div class="stat-label">TAPS</div>
                        </div>
                    </div>

                    <div class="leaderboard-title">üèÜ SFR LEADERBOARD ¬∑ ${leaderboardWithPlayer.length} PLAYERS</div>
                    <div class="leaderboard-list" id="leaderboardList">
                        ${leaderboardHtml}
                    </div>

                    <div class="leaderboard-footer">
                        You're #${yourRank} of ${leaderboardWithPlayer.length}!
                        ${yourRank === 1 ? ' üèÜ CHAMPION!' : yourRank <= 3 ? ' ‚ö° PODIUM FINISH!' : ''}
                    </div>

                    <div class="button-group">
                        <button class="action-btn" id="backFromLeaderboardBtn">‚Üê BACK</button>
                        <button class="action-btn secondary" id="shareBtn">üì§ SHARE</button>
                    </div>
                `;
                
                overlay.appendChild(leaderboardCard);
                overlay.classList.remove('hidden');
                
                setTimeout(() => {
                    const leaderboardList = document.getElementById('leaderboardList');
                    const yourRow = leaderboardList?.querySelector('.leaderboard-row.you');
                    if (yourRow) {
                        yourRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 100);
                
                // FIXED: Back button with proper navigation
                document.getElementById('backFromLeaderboardBtn').addEventListener('click', () => {
                    overlay.classList.add('hidden');
                    
                    if (fromCompletion) {
                        const world = worlds[currentWorld];
                        const allUnitsCompleted = world.units.every(u => u.wordsCompleted === 20);
                        
                        if (allUnitsCompleted) {
                            setTimeout(() => {
                                showWorldArtifactPopup();
                            }, 100);
                        } else {
                            const nextIngotId = currentUnit + 1;
                            const nextUnit = world.units.find(u => u.id === nextIngotId);
                            
                            if (nextUnit && nextUnit.unlocked) {
                                setTimeout(() => {
                                    showNextIngotPreview();
                                }, 100);
                            } else {
                                renderAll();
                            }
                        }
                    } else {
                        renderAll();
                    }
                });

                document.getElementById('shareBtn').addEventListener('click', () => {
                    const text = `I completed ${worlds[currentWorld].name} Ingot ${currentUnit} in Spellforge with a score of ${playerSFR} SFR (${playerRating.title})! Rank #${yourRank} of ${leaderboardWithPlayer.length}! üîÆ‚öíÔ∏è`;
                    if (tg) {
                        tg.shareToStory?.(text);
                    } else {
                        alert('Share: ' + text);
                    }
                });
            }

            // ---------- GAME MECHANICS ----------
            function handleWordCompletion(wordIndex) {
                if (!completedWords.includes(wordIndex)) {
                    completedWords.push(wordIndex);
                    
                    const unit = worlds[currentWorld].units.find(u => u.id === currentUnit);
                    if (unit) {
                        unit.wordsCompleted = completedWords.length;
                    }
                    
                    const words = getCurrentUnitWords();
                    if (words && words.length > 0 && words[wordIndex]) {
                        const wordData = words[wordIndex];
                        showWordCard(wordData);
                    }
                }

                activeWordIndex = null;
                currentPosition = 0;
                renderAll();
                updateWorldDisplay();
                
                const unit = worlds[currentWorld].units.find(u => u.id === currentUnit);
                if (unit && unit.wordsCompleted === unit.totalWords) {
                    const accuracy = totalTaps === 0 ? 100 : Math.round((correctTaps / totalTaps) * 100);
                    
                    playerPerformance.currentStreak++;
                    playerPerformance.bestStreak = Math.max(playerPerformance.bestStreak, playerPerformance.currentStreak);
                    playerPerformance.lastAccuracy = accuracy;
                    playerPerformance.lastAttemptFailed = false;
                    playerPerformance.lastPlayedDate = new Date().toISOString();
                    playerPerformance.worldProgress[currentWorld].completed++;
                    
                    const chance = calculateSuccessChance(currentUnit);
                    const riskBonus = calculateRiskBonus(chance.base, chance.final, true);
                    playerPerformance.totalRiskBonus += riskBonus;
                    
                    playerPerformance.ingotHistory.push({
                        id: currentUnit,
                        success: true,
                        accuracy: accuracy,
                        time: gameStartTime ? Math.floor((Date.now() - gameStartTime) / 1000) : 0,
                        sfr: calculateSFR(gameStartTime ? Math.floor((Date.now() - gameStartTime) / 1000) : 0, accuracy, totalTaps, correctTaps),
                        date: new Date().toISOString()
                    });
                    
                    setTimeout(() => {
                        showIngotCompletePopup();
                        
                        const nextUnit = worlds[currentWorld].units.find(u => u.id === currentUnit + 1);
                        if (nextUnit) {
                            nextUnit.unlocked = true;
                        }
                    }, 500);
                }
            }

            function handleLetterTap(letter, indexInGrid) {
                if (gameCompleted) return;
                
                totalTaps++;
                
                if (activeWordIndex === null) {
                    tg?.HapticFeedback?.notificationOccurred?.('warning');
                    return;
                }
                
                if (completedWords.includes(activeWordIndex)) {
                    activeWordIndex = null;
                    currentPosition = 0;
                    renderAll();
                    return;
                }

                const words = getCurrentUnitWords();
                if (!words || words.length === 0) return;
                
                const targetWord = words[activeWordIndex].word;
                const neededLetter = targetWord[currentPosition];

                if (letter.toLowerCase() !== neededLetter.toLowerCase()) {
                    tg?.HapticFeedback?.notificationOccurred?.('error');
                    renderAll();
                    return;
                }

                correctTaps++;
                currentLetters.splice(indexInGrid, 1);
                currentPosition++;
                
                tg?.HapticFeedback?.impactOccurred?.('light');
                renderAll();

                if (currentPosition === targetWord.length) {
                    handleWordCompletion(activeWordIndex);
                }
            }

            // ---------- RENDER UI ----------
            function renderAll() {
                const words = getCurrentUnitWords();
                
                const wordContainer = document.getElementById('wordListContainer');
                if (wordContainer) {
                    wordContainer.innerHTML = '';
                    if (words && words.length > 0) {
                        words.forEach((w, idx) => {
                            const chip = document.createElement('div');
                            chip.className = 'word-chip';
                            if (completedWords.includes(idx)) {
                                chip.classList.add('completed');
                            } else if (activeWordIndex === idx) {
                                chip.classList.add('active-word');
                            }
                            chip.innerText = w.word;
                            chip.addEventListener('click', (e) => {
                                e.stopPropagation();
                                if (completedWords.includes(idx) || gameCompleted) return;
                                activeWordIndex = idx;
                                currentPosition = 0;
                                renderAll();
                                tg?.HapticFeedback?.selectionChanged?.();
                            });
                            wordContainer.appendChild(chip);
                        });
                    } else {
                        const placeholder = document.createElement('div');
                        placeholder.className = 'word-chip';
                        placeholder.innerText = "Coming Soon";
                        wordContainer.appendChild(placeholder);
                    }
                }

                if (activeWordIndex !== null && !completedWords.includes(activeWordIndex) && !gameCompleted && words && words.length > 0) {
                    const w = words[activeWordIndex].word;
                    const progressWord = w.split('').map((l, i) => i < currentPosition ? l.toUpperCase() : '_').join(' ');
                    document.getElementById('activeWordDisplay').innerText = progressWord || '‚Äî';
                    const nextChar = (currentPosition < w.length) ? w[currentPosition].toUpperCase() : '‚úÖ';
                    document.getElementById('nextLetterDisplay').innerText = nextChar;
                } else {
                    document.getElementById('activeWordDisplay').innerText = '‚Äî';
                    document.getElementById('nextLetterDisplay').innerText = '?';
                }

                const gridContainer = document.getElementById('letterGridContainer');
                gridContainer.innerHTML = '';
                if (currentLetters.length > 0) {
                    currentLetters.forEach((letter, idx) => {
                        const tile = document.createElement('div');
                        tile.className = 'letter-tile';
                        tile.innerText = letter.toUpperCase();
                        tile.addEventListener('click', (e) => {
                            e.preventDefault();
                            handleLetterTap(letter, idx);
                        });
                        gridContainer.appendChild(tile);
                    });
                }

                const artifactEl = document.getElementById('artifactText');
                const unit = worlds[currentWorld].units.find(u => u.id === currentUnit);
                if (unit) {
                    if (unit.wordsCompleted === 20) {
                        artifactEl.innerText = 'üåü UNIT COMPLETE! üåü';
                    } else {
                        artifactEl.innerText = `üîí ${unit.wordsCompleted}/20`;
                    }
                }
            }

            // ---------- RESET ----------
            function confirmReset() {
                if (tg) {
                    tg.showConfirm('Restart this ingot? All progress will be lost.', (ok) => {
                        if (ok) {
                            resetForNewUnit();
                            tg.HapticFeedback?.impactOccurred?.('heavy');
                        }
                    });
                } else {
                    if (confirm('Restart this ingot?')) {
                        resetForNewUnit();
                    }
                }
            }

            // ---------- INITIALIZATION ----------
            document.getElementById('resetButton').addEventListener('click', confirmReset);
            document.getElementById('unitSelector').addEventListener('change', (e) => {
                currentUnit = parseInt(e.target.value);
                resetForNewUnit();
                updateWorldDisplay();
            });

            updateWorldDisplay();
            resetForNewUnit();

            if (tg) {
                tg.onEvent('backButtonClicked', () => {
                    tg.close();
                });
                tg.BackButton?.show();
                tg.ready();
            }
        })();
    </script>
</body>
</html>
